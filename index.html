<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minecraft Avatar Creator</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    html, body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      overflow: hidden;
    }


    * {
      box-sizing: border-box;
    }


    .app-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }


    .banner-panel {
      background: white;
      padding: 15px 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-shrink: 0;
      gap: 10px;
      border-bottom: 2px solid #e2e8f0;
      margin: 20px 20px 0 20px;
      border-radius: 16px;
    }


    .banner-title {
      font-size: 2.5em;
      font-weight: 900;
      color: #2d3748;
      letter-spacing: 2px;
      margin: 0;
      white-space: nowrap;
      text-align: center;
    }


    .banner-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      width: 100%;
      flex-wrap: nowrap;
    }


    .banner-btn {
      background: white;
      border: 2px solid #e2e8f0;
      color: #4a5568;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9em;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }


    .banner-btn:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
      transform: translateY(-2px);
    }


    .banner-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }


    .banner-btn:disabled:hover {
      transform: none;
      background: white;
    }


    .banner-toggle {
      background: white;
      border: 2px solid #e2e8f0;
      color: #4a5568;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9em;
      transition: all 0.2s;
    }


    .banner-toggle.active {
      background: #48bb78;
      border-color: #48bb78;
      color: white;
    }


    .banner-toggle:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
    }


    .banner-toggle.active:hover {
      background: #38a169;
      border-color: #38a169;
    }


    .content-container {
      display: flex;
      flex-direction: row;
      flex: 1;
      gap: 20px;
      padding: 20px;
      overflow: hidden;
      width: 100%;
    }


    .left-panel {
      display: flex;
      flex-direction: column;
      gap: 15px;
      flex: 0 1 400px;
      max-width: 500px;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      overflow-y: auto;
      min-width: 300px;
    }


    .right-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
      flex: 1 1 auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      overflow-y: auto;
      min-width: 400px;
    }


    .tab-navigation {
      display: flex;
      gap: 1%;
      margin-bottom: 3%;
      border-bottom: 2px solid #e2e8f0;
    }


    .tab-btn {
      flex: 1;
      padding: 2%;
      border: none;
      background: transparent;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: #718096;
      transition: all 0.2s;
      font-size: 0.85em;
    }


    .tab-btn:hover {
      color: #4a5568;
      background: #f7fafc;
    }


    .tab-btn.active {
      color: #4299e1;
      border-bottom-color: #4299e1;
    }


    .tab-content {
      display: none;
    }


    .tab-content.active {
      display: block;
    }


    .editor-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      display: none;
      flex-direction: column;
    }


    .editor-overlay.active {
      display: flex;
    }


    .editor-header {
      background: #2d3748;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #4a5568;
    }


    .editor-header h2 {
      color: white;
      margin: 0;
      font-size: 1.5em;
    }


    .editor-close-btn {
      background: #e53e3e;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1em;
      transition: all 0.2s;
    }


    .editor-close-btn:hover {
      background: #c53030;
      transform: scale(1.05);
    }


    .editor-main {
      display: grid;
      grid-template-columns: minmax(260px, 320px) minmax(0, 1fr) minmax(200px, 240px);
      grid-template-rows: 1fr;
      width: 100%;
      height: 100%;
      overflow: hidden;
      column-gap: 0;
    }


    .editor-tools-panel {
      background: #1a202c;
      padding: 20px;
      overflow-y: auto;
      border-right: 2px solid #4a5568;
    }


    .editor-canvas-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #2d3748;
      padding: 20px;
      overflow: auto;
    }


    .editor-preview-panel {
      background: #1a202c;
      padding: 20px;
      display: flex;
      flex-direction: column;
      border-left: 2px solid #4a5568;
    }


    .editor-section-title {
      color: white;
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #4a5568;
    }


    .editor-tool-group {
      margin-bottom: 20px;
    }


    .editor-tool-label {
      color: #a0aec0;
      font-size: 0.9em;
      margin-bottom: 8px;
      display: block;
    }


    .editor-canvas-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
      min-height: 400px;
    }


    .editor-preview-3d {
      width: 100%;
      height: 200px;
      background: #2d3748;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
    }


    .editor-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }


    .preview-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      position: relative;
      overflow: hidden;
    }
    
    #preview-canvas {
      width: 100%;
      height: 100%;
      min-height: 400px;
    }


    .actions-container {
      display: flex;
      flex-direction: column;
      gap: 2%;
    }


    h1 {
      color: #4a5568;
      font-size: 1.5em;
      margin: 0 0 1.5% 0;
      text-align: center;
    }


    .instructions {
      background: #edf2f7;
      padding: 2%;
      border-radius: 8px;
      margin-bottom: 2%;
      font-size: 0.85em;
      color: #2d3748;
      text-align: center;
    }


    .section {
      margin-bottom: 20px;
    }


    .section-title {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }


    .color-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
    }


    .color-swatch {
      width: 100%;
      height: 50px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      padding: 0;
    }


    .color-swatch:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }


    .color-swatch:focus {
      outline: 2px solid #4299e1;
      outline-offset: 2px;
    }


    .color-swatch.selected {
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
    }


    .button-group {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }


    .option-btn {
      padding: 10px;
      border: 2px solid #e2e8f0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.8em;
      font-weight: 500;
      color: #4a5568;
    }


    .option-btn:hover {
      background: #edf2f7;
      border-color: #cbd5e0;
    }


    .option-btn.selected {
      background: #4299e1;
      color: white;
      border-color: #4299e1;
    }


    .option-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: #f7fafc;
      color: #a0aec0;
    }


    .option-btn:disabled:hover {
      background: #f7fafc;
      border-color: #e2e8f0;
    }


    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 10px;
    }


    .switch {
      position: relative;
      width: 50px;
      height: 26px;
      background: #cbd5e0;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
      border: none;
      padding: 0;
    }


    .switch:focus {
      outline: 2px solid #4299e1;
      outline-offset: 2px;
    }


    .switch.active {
      background: #48bb78;
    }


    .switch-handle {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
      pointer-events: none;
    }


    .switch.active .switch-handle {
      transform: translateX(24px);
    }


    .switch-label {
      font-size: 0.95em;
      color: #4a5568;
      font-weight: 500;
    }


    .action-button {
      width: 100%;
      padding: 2%;
      border: none;
      border-radius: 8px;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 1.5%;
    }


    .primary-btn {
      background: #48bb78;
      color: white;
    }


    .primary-btn:hover {
      background: #38a169;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
    }


    .secondary-btn {
      background: #4299e1;
      color: white;
    }


    .secondary-btn:hover {
      background: #3182ce;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
    }


    .tertiary-btn {
      background: #ed8936;
      color: white;
    }


    .tertiary-btn:hover {
      background: #dd6b20;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(237, 137, 54, 0.4);
    }


    .sticker-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 10px;
    }


    .sticker-btn {
      padding: 12px;
      border: 2px solid #e2e8f0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.3em;
      transition: all 0.2s;
    }


    .sticker-btn:hover {
      background: #edf2f7;
      transform: scale(1.1);
    }


    .pixel-canvas {
      cursor: crosshair;
      display: block;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }
    .palette-row {
      display: flex;
      gap: 6px;
      justify-content: space-between;
      margin-top: 4px;
    }

    .palette-swatch {
      flex: 1;
      min-width: 0;
      height: 32px;
      border-radius: 6px;
      border: 2px solid #cbd5e0;
      background: #2d3748;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }

    .palette-swatch.active {
      border-color: #f6e05e;
      box-shadow: 0 0 0 2px rgba(246, 224, 94, 0.6);
      transform: scale(1.02);
    }

    .palette-swatch:focus {
      outline: none;
      box-shadow: 0 0 0 2px #63b3ed;
    }

    @media (max-width: 900px) {
      .editor-main {
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        height: auto;
        overflow-y: auto;
      }

      .editor-tools-panel,
      .editor-canvas-panel,
      .editor-preview-panel {
        width: 100%;
        border-right: none;
        border-left: none;
      }

      .editor-tools-panel {
        border-bottom: 2px solid #4a5568;
      }

      .editor-preview-panel {
        border-top: 2px solid #4a5568;
        margin-top: 12px;
      }
    }



    .editor-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: center;
    }


    .canvas-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f7fafc;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
    }


    .editor-tools {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }


    .tool-btn {
      padding: 10px 16px;
      border: 2px solid #e2e8f0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }


    .tool-btn:hover {
      background: #edf2f7;
      border-color: #cbd5e0;
    }


    .tool-btn.active {
      background: #4299e1;
      color: white;
      border-color: #4299e1;
    }


    .color-picker-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
    }


    .color-picker-wrapper label {
      font-size: 0.9em;
      font-weight: 500;
      color: #4a5568;
    }


    .color-picker-wrapper input[type="color"] {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }


    .brush-size-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
    }


    .brush-size-wrapper label {
      font-size: 0.9em;
      font-weight: 500;
      color: #4a5568;
    }


    .brush-size-wrapper input[type="range"] {
      width: 100px;
    }


    @media (max-width: 768px) {
      .banner-title {
        font-size: 1.8em;
      }
      
      .banner-controls {
        gap: 5px;
      }
      
      .banner-btn, .banner-toggle {
        padding: 6px 12px;
        font-size: 0.8em;
      }
      
      .content-container {
        flex-direction: column;
        overflow-y: auto;
      }
      
      .left-panel, .right-panel {
        width: 100%;
      }
      
      .preview-container {
        min-height: 400px;
      }
      
      .tab-btn {
        font-size: 0.85em;
        padding: 2%;
      }
      
      .editor-main {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        overflow-y: auto;
      }
      
      .editor-tools-panel,
      .editor-canvas-panel,
      .editor-preview-panel {
        border: none;
        border-bottom: 2px solid #4a5568;
        max-height: none;
      }
      
      .editor-preview-panel {
        border-bottom: none;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 
<style>
@keyframes glowPulse {
    0% { box-shadow: 0 0 5px #FFD700; }
    50% { box-shadow: 0 0 15px #FFD700; }
    100% { box-shadow: 0 0 5px #FFD700; }
}
.pixel.glow-highlight {
    outline: 2px solid #FFD700;
    animation: glowPulse 1s infinite;
}
</style>

</head>
 <body>
  <div class="app-container">
   <header class="banner-panel">
    <h1 class="banner-title" id="app-title">ğŸ® MINECRAFT ME! ğŸ®</h1>
<div class="banner-controls">
  <button class="banner-toggle" id="fullscreen-toggle">ğŸ–¥ï¸ Fullscreen</button>
  <button class="banner-toggle" id="language-toggle">ğŸŒ EspaÃ±ol</button> 
  <button class="banner-toggle" id="tts-toggle">ğŸ”Š Text-to-Speech</button>
</div>
   </header>
   <main class="content-container">
    <div class="left-panel">
     <div class="instructions" id="instructions">
      Create your unique Minecraft character!
     </div><button class="action-button tertiary-btn" id="randomize-btn" style="margin-bottom: 15px;">ğŸ² Randomize Avatar</button>
     <div class="tab-navigation">
      <button
        class="tab-btn active"
        data-tab="identity"
        title="Identity: body, face, hair, and eyes"
        aria-label="Identity: body, face, hair, and eyes"
      >
        IDENTITY
      </button>
      <button
        class="tab-btn"
        data-tab="clothing"
        title="Clothing: tops, bottoms, shoes, and patterns"
        aria-label="Clothing: tops, bottoms, shoes, and patterns"
      >
        CLOTHING
      </button>
      <button
        class="tab-btn"
        data-tab="decals"
        title="Decals: stickers and icons for your outfit"
        aria-label="Decals: stickers and icons for your outfit"
      >
        DECALS
      </button>
      <button
        class="tab-btn"
        data-tab="editor"
        title="Editor: advanced pixel-by-pixel tools"
        aria-label="Editor: advanced pixel-by-pixel tools"
      >
        EDITOR
      </button>
     </div>
     <div class="tab-content active" id="identity-tab">
      <div class="section">
       <div class="section-title">
        ğŸ§ Body Type
       </div>
       <div class="button-group">
        <button class="option-btn selected" data-model="standard" title="Standard body type" aria-label="Standard body type">ğŸ§ Standard</button>
        <button class="option-btn" data-model="slim" title="Slim body type" aria-label="Slim body type">ğŸ§’ Slim</button>
       </div>
      </div>
      <div class="section">
       <div class="section-title">
        ğŸ˜Š Face Style
       </div>
       <div class="button-group">
        <button class="option-btn selected" data-facestyle="classic" title="Classic Minecraft-style face" aria-label="Classic Minecraft-style face">ğŸ™‚ Classic</button>
        <button class="option-btn" data-facestyle="anime" title="Anime style face" aria-label="Anime style face">âœ¨ Anime</button>
       </div>
      </div>
      <div class="section">
       <div class="section-title">
        ğŸ¨ Skin Tone
       </div>
       <div class="color-grid" id="skin-tone-grid"></div>
      </div>
      <div class="section">
       <div class="section-title">
        ğŸ’‡ Hair Color
       </div>
       <div class="color-grid" id="hair-color-grid"></div>
      </div>
      <div class="section">
       <div class="section-title">
        ğŸ’‡â€â™€ï¸ Hair Style
       </div>
       <div class="button-group">
        <button class="option-btn selected" data-hairstyle="short" title="Short hair" aria-label="Short hair">âœ‚ï¸ Short</button>
        <button class="option-btn" data-hairstyle="long" title="Long hair" aria-label="Long hair">ğŸ‘© Long</button>
        <button class="option-btn" data-hairstyle="none" title="No hair" aria-label="No hair">ğŸ§‘â€ğŸ¦² Bald</button>
       </div>
      </div>
      <div class="section">
       <div class="section-title">
        âœ‚ï¸ Bangs
       </div>
       <div class="button-group">
        <button class="option-btn selected" data-bangs="short" title="Short bangs" aria-label="Short bangs">Short</button>
        <button class="option-btn" data-bangs="long" title="Long bangs" aria-label="Long bangs">Long</button>
        <button class="option-btn" data-bangs="layered" title="Layered bangs" aria-label="Layered bangs">Layered</button>
        <button class="option-btn" data-bangs="asymmetric" title="Asymmetric bangs" aria-label="Asymmetric bangs">Asymmetric</button>
       </div>
      </div>
      <div class="section">
       <div class="section-title">
        ğŸŒŠ Hair Texture
       </div>
       <div class="button-group">
        <button class="option-btn selected" data-hairtexture="straight" title="Straight hair" aria-label="Straight hair">Straight</button>
        <button class="option-btn" data-hairtexture="wavy" title="Wavy hair" aria-label="Wavy hair">Wavy</button>
        <button class="option-btn" data-hairtexture="curly" title="Curly hair" aria-label="Curly hair">Curly</button>
       </div>
      </div>
      <div class="section">
       <div class="section-title">
        ğŸ‘ï¸ Eye Color
       </div>
       <div class="color-grid" id="eye-color-grid"></div>
      </div>
      <div class="section">
       <div class="section-title">
        ğŸ˜Š Facial Features
       </div>
       <div class="toggle-switch">
        <button class="switch" id="blush-toggle" role="switch" aria-checked="false" aria-label="Toggle blush">
         <div class="switch-handle"></div></button> <span class="switch-label">Blush</span>
       </div>
      </div>
      <div class="section" id="expression-section">
       <div class="section-title">
        ğŸ˜„ Expression
       </div>
       <div class="button-group">
        <button class="option-btn selected" data-expression="smile" title="Smile" aria-label="Smile">ğŸ™‚ Smile</button>
        <button class="option-btn" data-expression="happy" title="Happy" aria-label="Happy">ğŸ˜„ Happy</button>
        <button class="option-btn" data-expression="neutral" title="Neutral" aria-label="Neutral">ğŸ˜ Neutral</button>
        <button class="option-btn" data-expression="surprised" title="Surprised" aria-label="Surprised">ğŸ˜® Surprised</button>
       </div>
      </div>
      <div class="section">
       <div class="section-title">
        ğŸ‘“ Glasses
       </div>
       <div class="toggle-switch">
        <button class="switch" id="glasses-toggle" role="switch" aria-checked="false" aria-label="Toggle glasses">
         <div class="switch-handle"></div></button> <span class="switch-label">Wear Glasses</span>
       </div>
       <div style="margin-top: 2%;">
        <label id="glasses-color-label" style="font-size: 0.9em; color: #4a5568; display: block; margin-bottom: 1%;">Glasses Color</label>
        <div class="color-grid" id="glasses-color-grid" role="radiogroup" aria-labelledby="glasses-color-label"></div>
       </div>
      </div>
     </div>
     <div class="tab-content" id="clothing-tab">
      <div class="section">
       <div class="section-title">
        ğŸ‘• Tops
       </div>
       <div class="button-group">
        <button class="option-btn selected" data-top="tshirt" title="T-shirt" aria-label="T-shirt">ğŸ‘• T-Shirt</button>
        <button class="option-btn" data-top="hoodie" title="Hoodie" aria-label="Hoodie">ğŸ§¥ Hoodie</button>
        <button class="option-btn" data-top="tank" title="Tank top" aria-label="Tank top">ğŸ½ Tank Top</button>
        <button class="option-btn" data-top="polo" title="Polo shirt" aria-label="Polo shirt">ğŸ‘” Polo</button>
       </div>
       <div style="margin-top: 2%;">
        <label style="font-size: 0.9em; color: #4a5568; display: block; margin-bottom: 1%;">Top Color</label>
        <div class="color-grid" id="top-color-grid"></div>
       </div>
      </div>
      <div class="section">
       <div class="section-title">
        ğŸ‘– Bottoms
       </div>
       <div class="button-group">
        <button class="option-btn selected" data-bottom="jeans" title="Jeans" aria-label="Jeans">ğŸ‘– Jeans</button>
        <button class="option-btn" data-bottom="shorts" title="Shorts" aria-label="Shorts">ğŸ©³ Shorts</button>
        <button class="option-btn" data-bottom="cargo" title="Cargo pants" aria-label="Cargo pants">ğŸ’ Cargo Pants</button>
        <button class="option-btn" data-bottom="joggers" title="Joggers" aria-label="Joggers">ğŸƒ Joggers</button>
       </div>
       <div style="margin-top: 2%;">
        <label style="font-size: 0.9em; color: #4a5568; display: block; margin-bottom: 1%;">Bottom Color</label>
        <div class="color-grid" id="bottom-color-grid"></div>
       </div>
      </div>
      <div class="section">
       <div class="section-title">
        ğŸ‘Ÿ Footwear
       </div>
       <div class="button-group">
        <button class="option-btn selected" data-footwear="sneakers" title="Sneakers" aria-label="Sneakers">ğŸ‘Ÿ Sneakers</button>
        <button class="option-btn" data-footwear="boots" title="Boots" aria-label="Boots">ğŸ¥¾ Boots</button>
        <button class="option-btn" data-footwear="converse" title="High tops" aria-label="High tops">ğŸ‘Ÿ Converse</button>
        <button class="option-btn" data-footwear="dress" title="Dress shoes" aria-label="Dress shoes">ğŸ‘ Dress Shoes</button>
       </div>
       <div style="margin-top: 2%;">
        <label style="font-size: 0.9em; color: #4a5568; display: block; margin-bottom: 1%;">Footwear Color</label>
        <div class="color-grid" id="footwear-color-grid"></div>
       </div>
      </div>
      <div class="section">
       <div class="section-title">
        ğŸ§µ Patterns
       </div>
       <div class="button-group">
        <button class="option-btn" data-pattern="none">â¬œ No Pattern</button>
        <button class="option-btn" data-pattern="checkers" title="Checkerboard pattern" aria-label="Checkerboard pattern">ğŸ Checkers</button>
        <button class="option-btn" data-pattern="hstripes" title="Horizontal stripes" aria-label="Horizontal stripes">â– H-Stripes</button>
        <button class="option-btn" data-pattern="vstripes" title="Vertical stripes" aria-label="Vertical stripes">ã€°ï¸ V-Stripes</button>
        <button class="option-btn" data-pattern="dots" title="Dots pattern" aria-label="Dots pattern">âš« Dots</button>
        <button class="option-btn" data-pattern="plaid" title="Plaid pattern" aria-label="Plaid pattern">ğŸ”² Plaid</button>
        <button class="option-btn" data-pattern="camo" title="Camouflage pattern" aria-label="Camouflage pattern">ğŸŒ¿ Camo</button>
       </div>
       <div style="margin-top: 2%;">
        <label style="font-size: 0.9em; color: #4a5568; display: block; margin-bottom: 1%;">Pattern Color 1</label>
        <div class="color-grid" id="pattern-color1-grid"></div>
       </div>
       <div style="margin-top: 2%;">
        <label style="font-size: 0.9em; color: #4a5568; display: block; margin-bottom: 1%;">Pattern Color 2</label>
        <div class="color-grid" id="pattern-color2-grid"></div>
       </div>
      </div>
     </div>
     <div class="tab-content" id="decals-tab">
      <div class="section">
       <div class="section-title">
        âœ¨ Sticker Library
       </div>
       <div class="sticker-grid">
        <button class="sticker-btn" data-sticker="none" style="background: #f7fafc; border: 2px dashed #cbd5e0;">âŒ</button>
        <button class="sticker-btn" data-sticker="heart" title="Heart" aria-label="Heart">â¤ï¸</button>
        <button class="sticker-btn" data-sticker="smiley" title="Smiley face" aria-label="Smiley face">ğŸ˜Š</button>
        <button class="sticker-btn" data-sticker="ghost" title="Ghost" aria-label="Ghost">ğŸ‘»</button>
        <button class="sticker-btn" data-sticker="basketball" title="Basketball" aria-label="Basketball">ğŸ€</button>
        <button class="sticker-btn" data-sticker="music" title="Music note" aria-label="Music note">ğŸµ</button>
        <button class="sticker-btn" data-sticker="flower" title="Flower" aria-label="Flower">ğŸŒ¸</button>
        <button class="sticker-btn" data-sticker="rainbow" title="Rainbow" aria-label="Rainbow">ğŸŒˆ</button>
        <button class="sticker-btn" data-sticker="diamond" title="Diamond" aria-label="Diamond">ğŸ’</button>
        <button class="sticker-btn" data-sticker="skull" title="Skull" aria-label="Skull">ğŸ’€</button>
        <button class="sticker-btn" data-sticker="creeper" title="Creeper face" aria-label="Creeper face">ğŸ˜</button>
        <button class="sticker-btn" data-sticker="sun" title="Sun" aria-label="Sun">â˜€ï¸</button>
        <button class="sticker-btn" data-sticker="apple" title="Apple" aria-label="Apple">ğŸ</button>
        <button class="sticker-btn" data-sticker="pumpkin" title="Pumpkin" aria-label="Pumpkin">ğŸƒ</button>
        <button class="sticker-btn" data-sticker="gamepad" title="Game controller" aria-label="Game controller">ğŸ®</button>
        <button class="sticker-btn" data-sticker="soccer" title="Soccer ball" aria-label="Soccer ball">âš½</button>
        </div>
      </div>
     </div>
     <div class="tab-content" id="editor-tab">
      <div class="section">
       <div class="section-title">
        ğŸ¨ Advanced Pixel Editor
       </div>
       <p style="font-size: 0.85em; color: #718096; margin-bottom: 15px;">Click the button below to open the full-screen advanced editor with live preview!</p>
       <button class="action-button secondary-btn" id="open-editor-btn"> ğŸ¨ <span id="open-editor-text">Open Advanced Editor</span> </button>
      </div>
     </div>
    </div>
    <div class="right-panel">
     <div class="preview-container">
      <canvas id="preview-canvas"></canvas>
     </div>
     <div class="actions-container">
      <h1>ğŸ”  Final Touches & Export</h1>
      <div style="text-align: center; margin-bottom: 15px;">
       <label for="skin-name" style="font-weight: 600; color: #2d3748; display: block; margin-bottom: 5px; font-size: 0.9em;">Avatar Name for Export:</label>
       <input type="text" id="skin-name" placeholder="Enter name (e.g., Cool_Gamer_Skin)" style="width: 80%; max-width: 300px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; text-align: center;">
       <div style="font-size: 0.75em; color: #e53e3e; text-align: center; margin-top: 4px; line-height: 1.4;">
        âš ï¸ Don't use your real name or personal info!
       </div>
      </div>
      <input type="file" id="upload-skin" accept="image/png" style="display: none;">
      <button class="action-button secondary-btn" id="open-design-btn" style="margin-bottom: 10px;">
       ğŸ“‚ <span id="open-text">Open My Design</span>
      </button>
      <button class="action-button tertiary-btn" id="save-draft-btn" style="margin-bottom: 10px;">
       ğŸ’¾ <span id="save-text">Save My Draft</span>
      </button>
      <div style="font-size: 0.75em; color: #718096; text-align: center; margin-top: 8px; line-height: 1.4;">
       ğŸ’¡ Save your work often so you don't lose it!
      </div>
     </div>
     <button class="action-button primary-btn" id="download-btn">
      ğŸ® <span id="download-text">Download for Minecraft</span>
     </button>
     <div style="font-size: 0.75em; color: #718096; text-align: center; margin-top: 8px; line-height: 1.4;">
      âœ¨ This creates a file you can use in Minecraft Education!
     </div>
     <div style="text-align: center; padding: 15px 20px; font-size: 0.75em; color: #a0aec0;">
      <p style="margin: 0 0 5px 0;">This is an unofficial fan-made tool.</p>
      <p style="margin: 0;">Minecraft is a trademark of Mojang Synergies AB. The creator of this tool is not affiliated with or endorsed by Mojang or Microsoft.</p>
     </div>
    </div>
   </main>
   <div class="editor-overlay" id="editor-overlay">
    <div class="editor-header">
     <h2>ğŸ¨ Advanced Pixel Editor</h2><button class="editor-close-btn" id="close-editor-btn">âœ• Close Editor</button>
    </div>
    <div class="editor-main">
     <div class="editor-tools-panel">
      <div class="editor-section-title">
       ğŸ¯ Body Part
      </div>
      <div class="editor-tool-group">
       <label for="body-part-select" class="editor-tool-label">Select Part to Edit</label>
       <select id="body-part-select" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #4a5568; background: #2d3748; color: white;">
        <optgroup label="Head">
         <option value="head">Head</option>
         <option value="face">Face</option>
         <option value="hat">Hat (Overlay)</option>
        </optgroup>
        <optgroup label="Body">
         <option value="body">Body</option>
         <option value="leftArm">Left Arm</option>
         <option value="rightArm">Right Arm</option>
         <option value="leftLeg">Left Leg</option>
         <option value="rightLeg">Right Leg</option>
        </optgroup>
       </select>
      </div>
      <div class="editor-tool-group" id="face-select-group">
       <label for="face-select" class="editor-tool-label">Select Face to Edit</label>
       <select id="face-select" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #4a5568; background: #2d3748; color: white;">
        <option value="front">Front (Face)</option>
        <option value="back">Back</option>
        <option value="top">Top</option>
        <option value="bottom">Bottom</option>
        <option value="left">Left</option>
        <option value="right">Right</option>
       </select>
      </div>
      <div class="editor-section-title" style="margin-top: 30px;">
       ğŸ› ï¸ Tools
      </div>
      <div class="editor-tool-group">
       <label class="editor-tool-label">Drawing Tools</label>
       <div class="editor-tools">
        <button class="tool-btn active" data-tool="pen" id="pen-tool" title="Pen Tool (P)" aria-label="Pen Tool">âœ’ï¸ Pen</button>
        <button class="tool-btn" data-tool="eraser" id="eraser-tool" title="Eraser Tool (E)" aria-label="Eraser Tool">ğŸ§¼ Eraser</button>
        <button class="tool-btn" data-tool="dropper" id="dropper-tool" title="Color Picker (I)" aria-label="Color Picker Tool">ğŸ’§ Dropper</button>
        <button class="tool-btn" data-tool="fill" id="fill-tool" title="Fill Color (G)" aria-label="Fill Color">ğŸª£ Fill</button>
       </div>
      </div>
      <div class="editor-tool-group"><label class="editor-tool-label">Brush Color</label>
       <div class="color-picker-wrapper" style="width: 100%;"><input type="color" id="brush-color" value="#000000" style="width: 100%; height: 50px;">
       </div>
      </div>
      <div class="editor-tool-group">
       <label class="editor-tool-label">Favorite Colors</label>
       <p style="color: #a0aec0; font-size: 0.8em; margin-top: 0; margin-bottom: 8px;"> Tap a square to use a color. Tap a square, then â€œSave Brush Colorâ€ to store your current color there. </p>
       <div class="palette-row" id="palette-row">
        <button class="palette-swatch" data-index="0" aria-label="Favorite color 1" title="Favorite color 1"></button>
        <button class="palette-swatch" data-index="1" aria-label="Favorite color 2" title="Favorite color 2"></button>
        <button class="palette-swatch" data-index="2" aria-label="Favorite color 3" title="Favorite color 3"></button>
        <button class="palette-swatch" data-index="3" aria-label="Favorite color 4" title="Favorite color 4"></button>
        <button class="palette-swatch" data-index="4" aria-label="Favorite color 5" title="Favorite color 5"></button>
       </div>
       <button class="tool-btn" id="save-palette-color" style="margin-top: 8px;"> â­ Save Brush Color </button>
      </div>
      <div class="editor-tool-group"><label class="editor-tool-label">Quick Actions</label>
       <div style="display: flex; flex-direction: column; gap: 8px;">
        <button class="tool-btn" id="auto-shade">ğŸŒ“ Shade Helper</button>
        <button class="tool-btn" id="clear-face">ğŸ—‘ï¸ Clear Face</button>
        <div style="display: flex; gap: 8px;">
         <button class="tool-btn" id="editor-undo-btn" disabled>â†©ï¸ Undo</button>
         <button class="tool-btn" id="editor-redo-btn" disabled>â†ªï¸ Redo</button>
        </div>
       </div>
      </div>
     </div>
     <div class="editor-canvas-panel">
      <div class="editor-container">
       <div class="canvas-wrapper">
        <canvas id="pixel-editor-canvas" class="pixel-canvas"></canvas>
       </div>
       <p style="color: #a0aec0; font-size: 0.85em; margin-top: 15px;">Use the left panel to change color, and the 3D preview on the right to see your changes!</p>
      </div>
     </div>
     <div class="editor-preview-panel">
      <div class="editor-section-title">
       ğŸ‘€ Live Preview
      </div>
      <div id="editor-preview-3d" class="editor-preview-3d"></div>
      <div class="editor-actions">
       <button class="action-button primary-btn" id="editor-apply-btn"> âœ… Apply & Close</button>
       <p style="color: #a0aec0; font-size: 0.8em; text-align: center; margin-top: 0; margin-bottom: 5px;"> Applying will update the main avatar and save your history. </p>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    const skinCanvas = document.createElement('canvas');
    skinCanvas.width = 64;
    skinCanvas.height = 64;
    const skinContext = skinCanvas.getContext('2d');
    const editorCanvas = document.getElementById('pixel-editor-canvas');
    const editorContext = editorCanvas.getContext('2d');
    const previewCanvas = document.getElementById('preview-canvas');
    const previewContext = previewCanvas.getContext('2d');

    let ttsEnabled = false;
    let currentLanguage = 'en';

    let skinTexture;
    let scene, camera, renderer, skinMesh;
    let isDragging = false;
    let currentTool = 'pen';
    let currentBodyPart = 'head';
    let currentFace = 'front';
    let editorHistoryStack = [];
    let editorHistoryIndex = -1;
    let bodyPartFaces = {}; // Stores canvas data for each body part face
    let palette = ['#FFFFFF', '#000000', '#FF0000', '#00FF00', '#0000FF'];

    // Placeholder data for initial canvas for pixel editor
    const FACE_MAP = {
      head: {
        front: { x: 8, y: 8, w: 8, h: 8 },
        back: { x: 24, y: 8, w: 8, h: 8 },
        top: { x: 8, y: 0, w: 8, h: 8 },
        bottom: { x: 16, y: 0, w: 8, h: 8 },
        left: { x: 0, y: 8, w: 8, h: 8 },
        right: { x: 16, y: 8, w: 8, h: 8 },
      },
      body: {
        front: { x: 20, y: 20, w: 8, h: 12 },
        back: { x: 32, y: 20, w: 8, h: 12 },
        top: { x: 20, y: 16, w: 8, h: 4 },
        bottom: { x: 28, y: 16, w: 8, h: 4 },
        left: { x: 16, y: 20, w: 4, h: 12 },
        right: { x: 28, y: 20, w: 4, h: 12 },
      },
      // Arms and Legs follow a 4x12 structure (or 3x12 for slim)
      rightArm: {
        front: { x: 44, y: 20, w: 4, h: 12 },
        back: { x: 52, y: 20, w: 4, h: 12 },
        top: { x: 44, y: 16, w: 4, h: 4 },
        bottom: { x: 48, y: 16, w: 4, h: 4 },
        left: { x: 40, y: 20, w: 4, h: 12 },
        right: { x: 48, y: 20, w: 4, h: 12 },
      },
      leftArm: {
        front: { x: 36, y: 52, w: 4, h: 12 },
        back: { x: 44, y: 52, w: 4, h: 12 },
        top: { x: 36, y: 48, w: 4, h: 4 },
        bottom: { x: 40, y: 48, w: 4, h: 4 },
        left: { x: 32, y: 52, w: 4, h: 12 },
        right: { x: 40, y: 52, w: 4, h: 12 },
      },
      rightLeg: {
        front: { x: 4, y: 20, w: 4, h: 12 },
        back: { x: 12, y: 20, w: 4, h: 12 },
        top: { x: 4, y: 16, w: 4, h: 4 },
        bottom: { x: 8, y: 16, w: 4, h: 4 },
        left: { x: 0, y: 20, w: 4, h: 12 },
        right: { x: 8, y: 20, w: 4, h: 12 },
      },
      leftLeg: {
        front: { x: 20, y: 52, w: 4, h: 12 },
        back: { x: 28, y: 52, w: 4, h: 12 },
        top: { x: 20, y: 48, w: 4, h: 4 },
        bottom: { x: 24, y: 48, w: 4, h: 4 },
        left: { x: 16, y: 52, w: 4, h: 12 },
        right: { x: 24, y: 52, w: 4, h: 12 },
      },
    };

    const defaultConfig = {
      modelType: 'standard', // 'standard' or 'slim'
      faceStyle: 'classic', // 'classic' or 'anime'
      skinTone: '#F1C27D',
      hairColor: '#3B2E2E',
      hairStyle: 'short', // 'short', 'long', 'none'
      bangsStyle: 'short', // 'short', 'long', 'layered', 'asymmetric'
      hairTexture: 'straight', // 'straight', 'wavy', 'curly'
      eyeColor: '#4169E1',
      hasBlush: false,
      expression: 'smile', // 'smile', 'happy', 'neutral', 'surprised'
      hasGlasses: false,
      glassesColor: '#000000',
      topStyle: 'tshirt',
      topColor: '#3B82F6',
      bottomStyle: 'jeans',
      bottomColor: '#1E3A8A',
      footwear: 'sneakers',
      footwearColor: '#FFFFFF',
      pattern: null, // null, 'checkers', 'hstripes', 'vstripes', 'dots', 'plaid', 'camo'
      patternColor1: '#FFFFFF',
      patternColor2: '#000000',
      currentSticker: null, // { emoji: 'â¤ï¸' }
      history: [],
      historyIndex: -1,
      name: 'Minecraft Me Skin',
      title: "Minecraft Me! Skin Generator",
      downloadText: "Download for Minecraft Skins (All Versions)",
      openText: "Open My Design",
      saveText: "Save My Draft",
      randomize: "ğŸ² Randomize Avatar",
      undo: "Undo",
      redo: "Redo",
      primary_color: "#48bb78",
      secondary_color: "#4299e1",
      accent_color: "#ed8936",
      background_color: "#667eea",
      text_color: "#2d3748"
    };

    let config = { ...defaultConfig };
    let avatarState = { ...defaultConfig };

    const skinTones = [
      '#FFE0BD', '#FAD7B6', '#E5CACA', '#F1C27D', '#C68642', '#B78D67',
      '#D4AA78', '#B88B5E', '#8D5524', '#5F3A2A', '#452719', '#3B2219'
    ];

    const hairColors = [
      '#1C1C1C', '#3B2E2E', '#5C4033', '#8B4513', '#D2691E', '#F4A460',
      '#FFD700', '#FF6347', '#9370DB', '#4169E1', '#00CED1', '#32CD32'
    ];

    const topColors = [
      '#FF0000', '#FFA500', '#FFFF00', '#00FF00', '#0000FF', '#800080',
      '#FFC0CB', '#8B4513', '#000000', '#FFFFFF', '#808080', '#00FFFF'
    ];

    const bottomColors = [
      '#1E3A8A', '#3B82F6', '#60A5FA', '#1F2937', '#374151', '#6B7280',
      '#000000', '#4299E1', '#48BB78', '#ED8936', '#E53E3E', '#9370DB'
    ];

    const footwearColors = [
      '#FFFFFF', '#000000', '#6B7280', '#E53E3E', '#38A169', '#3182CE',
      '#D69E2E', '#972667', '#00FFFF', '#FF00FF', '#FFA500', '#FFC0CB'
    ];

    const glassesColors = [
      '#000000', '#FFFFFF', '#4A5568', '#E53E3E', '#4299E1', '#38A169',
      '#FFD700', '#800080'
    ];


    function getSkinName() {
      const input = document.getElementById('skin-name').value.trim();
      return input || 'Minecraft_Me_Skin';
    }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // --- History Functions ---

    function saveToHistory() {
      const dataUrl = skinCanvas.toDataURL();
      const newState = {
        ...avatarState,
        skinDataUrl: dataUrl,
        name: getSkinName(),
        config: JSON.parse(JSON.stringify(config))
      };

      // Clear redo history
      avatarState.history.splice(avatarState.historyIndex + 1);
      avatarState.history.push(newState);
      avatarState.historyIndex = avatarState.history.length - 1;

      if (avatarState.history.length > 50) {
        avatarState.history.shift();
        avatarState.historyIndex--;
      }
    }

    function applyHistory(index) {
      if (index >= 0 && index < avatarState.history.length) {
        const historyItem = avatarState.history[index];

        // Restore state
        Object.assign(avatarState, { ...historyItem });

        // Restore name
        document.getElementById('skin-name').value = historyItem.name;

        // Restore skin canvas from data URL
        const img = new Image();
        img.onload = () => {
          skinContext.clearRect(0, 0, 64, 64);
          skinContext.drawImage(img, 0, 0);
          updatePreview(false); // Update 3D model without saving to history
          updateUIFromState();
        };
        img.src = historyItem.skinDataUrl;

        avatarState.historyIndex = index;
        updateHistoryButtons();
      }
    }

    function undo() {
      if (avatarState.historyIndex > 0) {
        applyHistory(avatarState.historyIndex - 1);
        speak(translations[currentLanguage].undo + ' done');
      }
    }

    function redo() {
      if (avatarState.historyIndex < avatarState.history.length - 1) {
        applyHistory(avatarState.historyIndex + 1);
        speak(translations[currentLanguage].redo + ' done');
      }
    }

    function updateHistoryButtons() {
      const undoBtn = document.getElementById('undo-btn');
      const redoBtn = document.getElementById('redo-btn');

      if (undoBtn) {
        undoBtn.disabled = avatarState.historyIndex <= 0;
      }
      if (redoBtn) {
        redoBtn.disabled = avatarState.historyIndex >= avatarState.history.length - 1;
      }
    }

    // --- Color Utility Functions ---

    function hexToRgb(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return { r, g, b };
    }

    function rgbToHsl(r, g, b) {
      r /= 255;
      g /= 255;
      b /= 255;
      const max = Math.max(r, g, b),
        min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;

      if (max === min) {
        h = s = 0; // achromatic
      } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
          case r:
            h = (g - b) / d + (g < b ? 6 : 0);
            break;
          case g:
            h = (b - r) / d + 2;
            break;
          case b:
            h = (r - g) / d + 4;
            break;
        }
        h /= 6;
      }

      return { h, s, l };
    }

    function hslToRgb(h, s, l) {
      let r, g, b;

      if (s === 0) {
        r = g = b = l; // achromatic
      } else {
        const hue2rgb = (p, q, t) => {
          if (t < 0) t += 1;
          if (t > 1) t -= 1;
          if (t < 1 / 6) return p + (q - p) * 6 * t;
          if (t < 1 / 2) return q;
          if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
          return p;
        };
        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        r = hue2rgb(p, q, h + 1 / 3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1 / 3);
      }
      return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
    }

    // Create a color with slight variation in lightness for noise/texture effect
    function getNoiseColor(baseColor) {
      const rgb = hexToRgb(baseColor);
      const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
      const noise = (Math.random() - 0.5) * 0.05; // +/- 5% lightness
      let l = Math.max(0, Math.min(1, hsl.l + noise));
      if (l > 0.8) l = Math.max(0, l - 0.01); // Subtle darkening for very light colors
      if (l < 0.2) l = Math.min(1, l + 0.01); // Subtle lightening for very dark colors
      const newRgb = hslToRgb(hsl.h, hsl.s, l);

      // Convert back to hex
      return `#${((1 << 24) + (newRgb.r << 16) + (newRgb.g << 8) + newRgb.b).toString(16).slice(1).toUpperCase()}`;
    }

    function getPalette(baseColor) {
      const rgb = hexToRgb(baseColor);
      const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);

      const color = baseColor;
      const highlightRgb = hslToRgb(hsl.h, hsl.s, Math.min(1, hsl.l + 0.15));
      const shadowRgb = hslToRgb(hsl.h, hsl.s, Math.max(0, hsl.l - 0.15));
      const accentRgb = hslToRgb((hsl.h + 0.5) % 1, Math.min(1, hsl.s + 0.1), hsl.l);

      const toHex = (r, g, b) => `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase()}`;

      return {
        color: color,
        highlight: toHex(highlightRgb.r, highlightRgb.g, highlightRgb.b),
        shadow: toHex(shadowRgb.r, shadowRgb.g, shadowRgb.b),
        accent: toHex(accentRgb.r, accentRgb.g, accentRgb.b),
      };
    }

    // --- Drawing Utility Functions ---

    function drawBodyPart(ctx, x, y, w, h, palette) {
      for (let px = 0; px < w; px++) {
        for (let py = 0; py < h; py++) {
          const seed = (px * 13 + py * 7) % 100;

          // Apply slight noise for a pixelated texture feel
          if (seed < 85) {
            ctx.fillStyle = palette.color;
          } else if (seed < 95) {
            ctx.fillStyle = palette.highlight;
          } else {
            ctx.fillStyle = palette.shadow;
          }

          // Apply general shading (simulated light from top-left)
          if (py === 0) { // Top edge shadow
            if (palette.color !== palette.shadow) ctx.fillStyle = palette.shadow;
          }
          if (px === 0) { // Left edge highlight
            if (palette.color !== palette.highlight) ctx.fillStyle = palette.highlight;
          }
          if (px === w - 1) { // Right edge shadow
            if (palette.color !== palette.shadow) ctx.fillStyle = palette.shadow;
          }
          if (py === h - 1) { // Bottom edge shadow
            if (palette.color !== palette.shadow) ctx.fillStyle = palette.shadow;
          }

          ctx.fillRect(x + px, y + py, 1, 1);
        }
      }
    }

    function getPatternPixel(x, y, pattern) {
      const color1 = avatarState.patternColor1;
      const color2 = avatarState.patternColor2;

      switch (pattern) {
        case 'checkers':
          return (Math.floor(x / 2) + Math.floor(y / 2)) % 2 === 0 ? color1 : color2;
        case 'hstripes':
          return Math.floor(y / 2) % 2 === 0 ? color1 : color2;
        case 'vstripes':
          return Math.floor(x / 2) % 2 === 0 ? color1 : color2;
        case 'dots':
          return (x % 4 === 1 && y % 4 === 1) || (x % 4 === 3 && y % 4 === 3) ? color2 : color1;
        case 'plaid':
          if (y % 4 === 0 || y % 4 === 1) {
            return x % 4 === 0 || x % 4 === 1 ? color1 : color2;
          } else {
            return x % 4 === 0 || x % 4 === 1 ? color2 : color1;
          }
        case 'camo':
          const seeds = [(x * 17 + y * 23) % 100, (x * 13 + y * 19) % 100];
          if (seeds[0] < 30) return color1;
          if (seeds[1] < 30) return color2;
          return avatarState.topColor;
        default:
          return color1;
      }
    }

    function drawBodyPartWithPattern(ctx, x, y, w, h, palette) {
      const pattern = avatarState.pattern;
      if (!pattern) {
        drawBodyPart(ctx, x, y, w, h, palette);
        return;
      }

      for (let px = 0; px < w; px++) {
        for (let py = 0; py < h; py++) {
          let baseColor = getPatternPixel(x + px, y + py, pattern);

          // Get palette for the determined color
          let currentPalette = getPalette(baseColor);

          // Apply slight noise for a pixelated texture feel
          const seed = (px * 13 + py * 7) % 100;
          if (seed < 85) {
            ctx.fillStyle = currentPalette.color;
          } else if (seed < 95) {
            ctx.fillStyle = currentPalette.highlight;
          } else {
            ctx.fillStyle = currentPalette.shadow;
          }

          // Apply general shading (simulated light from top-left)
          if (py === 0) { // Top edge shadow
            if (currentPalette.color !== currentPalette.shadow) ctx.fillStyle = currentPalette.shadow;
          }
          if (px === 0) { // Left edge highlight
            if (currentPalette.color !== currentPalette.highlight) ctx.fillStyle = currentPalette.highlight;
          }
          if (px === w - 1) { // Right edge shadow
            if (currentPalette.color !== currentPalette.shadow) ctx.fillStyle = currentPalette.shadow;
          }
          if (py === h - 1) { // Bottom edge shadow
            if (currentPalette.color !== currentPalette.shadow) ctx.fillStyle = currentPalette.shadow;
          }

          ctx.fillRect(x + px, y + py, 1, 1);
        }
      }
    }


    function drawEyes(ctx, x, y, palette) {
      if (avatarState.faceStyle === 'classic') {
        // Classic Minecraft eyes: 2x2 black pixels, 1 pixel apart
        ctx.fillStyle = '#000000';
        ctx.fillRect(x + 2, y + 4, 1, 1);
        ctx.fillRect(x + 5, y + 4, 1, 1);

        // Eyeball color
        ctx.fillStyle = avatarState.eyeColor;
        ctx.fillRect(x + 2, y + 5, 1, 1);
        ctx.fillRect(x + 5, y + 5, 1, 1);

        // Highlight
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(x + 2, y + 5, 1, 1);
      } else if (avatarState.faceStyle === 'anime') {
        // Anime style: larger, more detailed eyes
        // Eye shape
        ctx.fillStyle = palette.shadow;
        ctx.fillRect(x + 1, y + 3, 2, 1);
        ctx.fillRect(x + 5, y + 3, 2, 1);
        ctx.fillRect(x + 1, y + 6, 2, 1);
        ctx.fillRect(x + 5, y + 6, 2, 1);

        // Sclera (white)
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(x + 1, y + 4, 2, 2);
        ctx.fillRect(x + 5, y + 4, 2, 2);

        // Iris (eye color)
        ctx.fillStyle = avatarState.eyeColor;
        ctx.fillRect(x + 2, y + 5, 1, 1);
        ctx.fillRect(x + 6, y + 5, 1, 1);

        // Pupil (black)
        ctx.fillStyle = '#000000';
        ctx.fillRect(x + 2, y + 5, 1, 1);
        ctx.fillRect(x + 6, y + 5, 1, 1);

        // Top line for eyes
        ctx.fillStyle = '#000000';
        ctx.fillRect(x + 1, y + 4, 2, 1);
        ctx.fillRect(x + 5, y + 4, 2, 1);
      }
    }


    function drawFace(ctx, palette) {
      const { x, y, w, h } = FACE_MAP.head.front;

      // Draw base face color (front of head)
      drawBodyPart(ctx, x, y, w, h, palette);

      // --- Facial Features ---

      // 1. Mouth/Expression
      ctx.fillStyle = '#000000';
      if (avatarState.expression === 'smile') {
        ctx.fillRect(x + 3, y + 7, 2, 1);
      } else if (avatarState.expression === 'happy') {
        ctx.fillRect(x + 3, y + 7, 2, 1);
        ctx.fillRect(x + 2, y + 6, 1, 1);
        ctx.fillRect(x + 5, y + 6, 1, 1);
      } else if (avatarState.expression === 'neutral') {
        ctx.fillRect(x + 3, y + 7, 2, 1);
      } else if (avatarState.expression === 'surprised') {
        ctx.fillRect(x + 3, y + 7, 2, 1);
        ctx.fillRect(x + 3, y + 6, 2, 1);
      }

      // 2. Eyes
      drawEyes(ctx, x, y, palette);

      // 3. Blush
      if (avatarState.hasBlush) {
        const blushColor = getPalette('#FFC0CB').shadow;
        ctx.fillStyle = blushColor;
        ctx.fillRect(x + 1, y + 6, 1, 1);
        ctx.fillRect(x + 6, y + 6, 1, 1);
      }

      // 4. Glasses (Overlay)
      if (avatarState.hasGlasses) {
        ctx.fillStyle = avatarState.glassesColor;
        // Bridge
        ctx.fillRect(x + 3, y + 5, 2, 1);
        // Frames
        ctx.fillRect(x + 1, y + 4, 1, 3);
        ctx.fillRect(x + 6, y + 4, 1, 3);
        ctx.fillRect(x + 1, y + 4, 2, 1);
        ctx.fillRect(x + 5, y + 4, 2, 1);
        ctx.fillRect(x + 1, y + 6, 2, 1);
        ctx.fillRect(x + 5, y + 6, 2, 1);
      }

      // 5. Hairline (To blend with hair, usually darker shade of skin)
      ctx.fillStyle = palette.shadow;
      ctx.fillRect(x, y, w, 1);
    }

    function getHairTexturePattern(texture) {
      if (texture === 'curly') {
        // Curly: tight clusters, more variation
        return (px, py) => {
          const clusterX = Math.floor(px / 2);
          const clusterY = Math.floor(py / 2);
          const seed = (clusterX * 17 + clusterY * 23 + px * 3 + py * 5) % 100;
          if (seed < 25) return 'shadow';
          if (seed < 40) return 'highlight';
          return 'color';
        };
      } else if (texture === 'wavy') {
        // Wavy: horizontal striations
        return (px, py) => {
          const seed = (py * 3) % 100;
          if (seed < 20) return 'highlight';
          if (seed > 80) return 'shadow';
          return 'color';
        };
      } else {
        // Straight: standard noise
        return (px, py) => {
          const seed = (px * 13 + py * 7) % 100;
          if (seed < 85) return 'color';
          if (seed < 95) return 'highlight';
          return 'shadow';
        };
      }
    }

    function drawBodyPartWithTexture(ctx, x, y, w, h, palette, texturePattern) {
      for (let px = 0; px < w; px++) {
        for (let py = 0; py < h; py++) {
          const colorKey = texturePattern(px, py);
          ctx.fillStyle = palette[colorKey];
          ctx.fillRect(x + px, y + py, 1, 1);
        }
      }
    }


    function drawHair(ctx, palette) {
      if (avatarState.hairStyle === 'none') return;

      // Apply texture-based shading pattern
      const texturePattern = getHairTexturePattern(avatarState.hairTexture);

      // Top of head (8x8 at 8, 0)
      drawBodyPartWithTexture(ctx, 8, 0, 8, 8, palette, texturePattern);
      // Back of head (8x8 at 24, 8)
      drawBodyPartWithTexture(ctx, 24, 8, 8, 8, palette, texturePattern);

      // --- Bangs (Front of Head Overlay) ---
      if (avatarState.bangsStyle === 'short') {
        // 8x2
        drawBodyPartWithTexture(ctx, 8, 8, 8, 2, palette, texturePattern);
      } else if (avatarState.bangsStyle === 'long') {
        // 8x4
        drawBodyPartWithTexture(ctx, 8, 8, 8, 4, palette, texturePattern);
      } else if (avatarState.bangsStyle === 'layered') {
        // 8x2 base
        drawBodyPartWithTexture(ctx, 8, 8, 8, 2, palette, texturePattern);
        // 2x2 fringe bits
        drawBodyPartWithTexture(ctx, 8, 10, 2, 2, palette, texturePattern);
        drawBodyPartWithTexture(ctx, 14, 10, 2, 2, palette, texturePattern);
      } else if (avatarState.bangsStyle === 'asymmetric') {
        // 8x3 base, then one side dips
        drawBodyPartWithTexture(ctx, 8, 8, 8, 3, palette, texturePattern);
        drawBodyPartWithTexture(ctx, 8, 11, 4, 1, palette, texturePattern);
      }

      // --- Sides of Head ---
      // Left side (8x8 at 0, 8)
      drawBodyPartWithTexture(ctx, 0, 8, 8, 8, palette, texturePattern);
      // Right side (8x8 at 16, 8)
      drawBodyPartWithTexture(ctx, 16, 8, 8, 8, palette, texturePattern);

      // --- Long Hair (Back Overlay) ---
      if (avatarState.hairStyle === 'long') {
        // Back of Torso area (8x10 at 32, 20)
        drawBodyPartWithTexture(ctx, 32, 20, 8, 10, palette, texturePattern);
      }
    }

    function drawClothing(ctx) {
      const topPalette = getPalette(avatarState.topColor);
      const bottomPalette = getPalette(avatarState.bottomColor);
      const footwearPalette = getPalette(avatarState.footwearColor);

      const armWidth = avatarState.modelType === 'slim' ? 3 : 4;

      // 1. TORSO (8x12 at 20, 20) - Top Layer (Top and Body Sides)
      drawBodyPartWithPattern(ctx, 20, 20, 8, 12, topPalette); // Front
      drawBodyPartWithPattern(ctx, 32, 20, 8, 12, topPalette); // Back
      drawBodyPartWithPattern(ctx, 16, 20, 4, 12, topPalette); // Left Side
      drawBodyPartWithPattern(ctx, 28, 20, 4, 12, topPalette); // Right Side
      drawBodyPartWithPattern(ctx, 20, 16, 8, 4, topPalette); // Top
      drawBodyPartWithPattern(ctx, 28, 16, 8, 4, topPalette); // Bottom (will be covered by pants, but draw for completeness)

      // 2. ARMS (4x12 or 3x12) - Top Layer
      // Right Arm
      drawBodyPartWithPattern(ctx, 44, 20, armWidth, 12, topPalette); // Front
      drawBodyPartWithPattern(ctx, 52, 20, armWidth, 12, topPalette); // Back
      drawBodyPartWithPattern(ctx, 40, 20, armWidth, 12, topPalette); // Left Side
      drawBodyPartWithPattern(ctx, 48, 20, armWidth, 12, topPalette); // Right Side
      drawBodyPartWithPattern(ctx, 44, 16, armWidth, 4, topPalette); // Top
      drawBodyPartWithPattern(ctx, 48, 16, armWidth, 4, topPalette); // Bottom (wrist)

      // Left Arm
      drawBodyPartWithPattern(ctx, 36, 52, armWidth, 12, topPalette); // Front
      drawBodyPartWithPattern(ctx, 44, 52, armWidth, 12, topPalette); // Back
      drawBodyPartWithPattern(ctx, 32, 52, armWidth, 12, topPalette); // Left Side
      drawBodyPartWithPattern(ctx, 40, 52, armWidth, 12, topPalette); // Right Side
      drawBodyPartWithPattern(ctx, 36, 48, armWidth, 4, topPalette); // Top
      drawBodyPartWithPattern(ctx, 40, 48, armWidth, 4, topPalette); // Bottom (wrist)

      // Apply Top Style Overrides
      if (avatarState.topStyle === 'tank') {
        // Remove sleeves: draw skin over the arm sides and top/bottom
        const skinPalette = getPalette(avatarState.skinTone);

        // Right Arm Sides (40, 20) and (48, 20) for 4x12
        drawBodyPart(ctx, 40, 20, armWidth, 12, skinPalette);
        drawBodyPart(ctx, 48, 20, armWidth, 12, skinPalette);
        drawBodyPart(ctx, 44, 16, armWidth, 4, skinPalette); // Top
        drawBodyPart(ctx, 48, 16, armWidth, 4, skinPalette); // Bottom (wrist)

        // Left Arm Sides (32, 52) and (40, 52) for 4x12
        drawBodyPart(ctx, 32, 52, armWidth, 12, skinPalette);
        drawBodyPart(ctx, 40, 52, armWidth, 12, skinPalette);
        drawBodyPart(ctx, 36, 48, armWidth, 4, skinPalette); // Top
        drawBodyPart(ctx, 40, 48, armWidth, 4, skinPalette); // Bottom (wrist)

        // Draw skin under the torso armpits (minimal coverage)
        drawBodyPart(ctx, 16, 20, 1, 4, skinPalette);
        drawBodyPart(ctx, 27, 20, 1, 4, skinPalette);
      }
      // Hoodie, Polo, etc. can have extra layers drawn here if needed (e.g., hood layer)

      // 3. LEGS (4x12) - Bottoms Layer (Legs)
      const legStart = avatarState.bottomStyle === 'shorts' ? 24 : 28; // Start point for leg color (shorts or full length)

      // Right Leg
      drawBodyPartWithPattern(ctx, 4, legStart, 4, 16 - legStart, bottomPalette); // Front
      drawBodyPartWithPattern(ctx, 12, legStart, 4, 16 - legStart, bottomPalette); // Back
      drawBodyPartWithPattern(ctx, 0, legStart, 4, 16 - legStart, bottomPalette); // Left Side
      drawBodyPartWithPattern(ctx, 8, legStart, 4, 16 - legStart, bottomPalette); // Right Side
      drawBodyPartWithPattern(ctx, 4, 20, 4, 4, bottomPalette); // Top
      drawBodyPartWithPattern(ctx, 8, 20, 4, 4, bottomPalette); // Bottom

      // Left Leg
      drawBodyPartWithPattern(ctx, 20, legStart, 4, 16 - legStart, bottomPalette); // Front
      drawBodyPartWithPattern(ctx, 28, legStart, 4, 16 - legStart, bottomPalette); // Back
      drawBodyPartWithPattern(ctx, 16, legStart, 4, 16 - legStart, bottomPalette); // Left Side
      drawBodyPartWithPattern(ctx, 24, legStart, 4, 16 - legStart, bottomPalette); // Right Side
      drawBodyPartWithPattern(ctx, 20, 48, 4, 4, bottomPalette); // Top
      drawBodyPartWithPattern(ctx, 24, 48, 4, 4, bottomPalette); // Bottom


      // Apply Bottom Style Overrides
      if (avatarState.bottomStyle === 'jeans') {
        // Subtle pockets/seams can be drawn here
      } else if (avatarState.bottomStyle === 'shorts') {
        // Draw skin color on the lower legs
        const skinPalette = getPalette(avatarState.skinTone);

        // Right Leg (Lower) - starts at y=28 (8 pixels of leg)
        drawBodyPart(ctx, 4, 28, 4, 8, skinPalette);
        drawBodyPart(ctx, 12, 28, 4, 8, skinPalette);
        drawBodyPart(ctx, 0, 28, 4, 8, skinPalette);
        drawBodyPart(ctx, 8, 28, 4, 8, skinPalette);

        // Left Leg (Lower)
        drawBodyPart(ctx, 20, 56, 4, 8, skinPalette);
        drawBodyPart(ctx, 28, 56, 4, 8, skinPalette);
        drawBodyPart(ctx, 16, 56, 4, 8, skinPalette);
        drawBodyPart(ctx, 24, 56, 4, 8, skinPalette);
      }

      // 4. FOOTWEAR (Boots, sneakers, etc.) - Final Layer on bottom of legs
      // Footwear is 4 pixels high (from y=28 to y=32 for Right Leg, or y=60 to y=64 for Left Leg)
      const footY = avatarState.modelType === 'slim' ? 28 : 28;

      // Right Leg (lower 4 pixels)
      drawBodyPart(ctx, 4, footY, 4, 4, footwearPalette); // Front
      drawBodyPart(ctx, 12, footY, 4, 4, footwearPalette); // Back
      drawBodyPart(ctx, 0, footY, 4, 4, footwearPalette); // Left Side
      drawBodyPart(ctx, 8, footY, 4, 4, footwearPalette); // Right Side
      drawBodyPart(ctx, 4, 16, 4, 4, footwearPalette); // Top (Right Leg Top - 4, 16 to 7, 19)

      // Left Leg (lower 4 pixels - y=60 to y=64)
      drawBodyPart(ctx, 20, 60, 4, 4, footwearPalette); // Front
      drawBodyPart(ctx, 28, 60, 4, 4, footwearPalette); // Back
      drawBodyPart(ctx, 16, 60, 4, 4, footwearPalette); // Left Side
      drawBodyPart(ctx, 24, 60, 4, 4, footwearPalette); // Right Side
      drawBodyPart(ctx, 20, 48, 4, 4, footwearPalette); // Top (Left Leg Top - 20, 48 to 23, 51)

      if (avatarState.footwear === 'boots') {
        // Draw boots higher (8 pixels high)
        drawBodyPart(ctx, 4, footY - 4, 4, 8, footwearPalette);
        drawBodyPart(ctx, 12, footY - 4, 4, 8, footwearPalette);
        drawBodyPart(ctx, 0, footY - 4, 4, 8, footwearPalette);
        drawBodyPart(ctx, 8, footY - 4, 4, 8, footwearPalette);
        drawBodyPart(ctx, 20, 56, 4, 8, footwearPalette);
        drawBodyPart(ctx, 28, 56, 4, 8, footwearPalette);
        drawBodyPart(ctx, 16, 56, 4, 8, footwearPalette);
        drawBodyPart(ctx, 24, 56, 4, 8, footwearPalette);
      } else if (avatarState.footwear === 'converse') {
        // Draw high tops (just an extra pixel of height)
        drawBodyPart(ctx, 4, footY - 1, 4, 5, footwearPalette);
        drawBodyPart(ctx, 12, footY - 1, 4, 5, footwearPalette);
        drawBodyPart(ctx, 0, footY - 1, 4, 5, footwearPalette);
        drawBodyPart(ctx, 8, footY - 1, 4, 5, footwearPalette);
        drawBodyPart(ctx, 20, 59, 4, 5, footwearPalette);
        drawBodyPart(ctx, 28, 59, 4, 5, footwearPalette);
        drawBodyPart(ctx, 16, 59, 4, 5, footwearPalette);
        drawBodyPart(ctx, 24, 59, 4, 5, footwearPalette);
      }
    }


    function drawSticker(ctx, emoji, x, y) {
      // Use the emoji as text, rendered onto the canvas
      ctx.save();
      ctx.font = '10px Arial'; // Simplified font size for 8x12 area
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#000000';
      ctx.fillText(emoji, x + 4, y + 6); // Centered on a standard 8x12 body part
      ctx.restore();
    }

    function drawDecals(ctx) {
      if (!avatarState.currentSticker) return;

      const { x, y } = FACE_MAP.body.front; // Front of Torso (20, 20, 8, 12)
      drawSticker(ctx, avatarState.currentSticker.emoji, x, y);
    }

    function generateSkin(saveHistory = true) {
      skinContext.clearRect(0, 0, 64, 64);

      const skinPalette = getPalette(avatarState.skinTone);
      const hairPalette = getPalette(avatarState.hairColor);

      // 1. Draw all base skin tones (including head top/bottom and face sides)
      drawBodyPart(skinContext, 0, 8, 8, 8, skinPalette); // Head Left
      drawBodyPart(skinContext, 8, 8, 8, 8, skinPalette); // Head Front
      drawBodyPart(skinContext, 16, 8, 8, 8, skinPalette); // Head Right
      drawBodyPart(skinContext, 24, 8, 8, 8, skinPalette); // Head Back
      drawBodyPart(skinContext, 8, 0, 8, 8, skinPalette); // Head Top
      drawBodyPart(skinContext, 16, 0, 8, 8, skinPalette); // Head Bottom

      // 2. Draw Clothing (which covers Torso, Arms, Legs)
      drawClothing(skinContext);

      // 3. Draw Hair (which covers Head)
      drawHair(skinContext, hairPalette);

      // 4. Draw Face Features (which covers Head Front)
      drawFace(skinContext, skinPalette);

      // 5. Draw Decals (which covers Clothing)
      drawDecals(skinContext);

      // Save the generated image data back to the bodyPartFaces for the editor to use
      saveCurrentFace(false); // Save the result of all drawing to the internal editor storage

      if (saveHistory) {
        saveToHistory();
      }
    }

    // --- 3D Viewer Functions (THREE.js) ---

    function setUVs(geometry, fx, fy, fw, fh, bx, by, bw, bh, tx, ty, tw, th, dx, dy, dw, dh, lx, ly, lw, lh, rx, ry, rw, rh) {
      const uvs = geometry.attributes.uv.array;
      const coords = [
        fx, fy, fw, fh, // Front
        bx, by, bw, bh, // Back
        tx, ty, tw, th, // Top
        dx, dy, dw, dh, // Bottom
        lx, ly, lw, lh, // Left
        rx, ry, rw, rh // Right
      ];

      const parts = ['front', 'back', 'top', 'bottom', 'left', 'right'];

      for (let i = 0; i < 6; i++) {
        const x = coords[i * 4] / 64;
        const y = 1 - (coords[i * 4 + 1] / 64);
        const w = coords[i * 4 + 2] / 64;
        const h = coords[i * 4 + 3] / 64;

        const offset = i * 8;

        // Vertices for face
        // Bottom Left (BL)
        uvs[offset] = x;
        uvs[offset + 1] = y - h;

        // Bottom Right (BR)
        uvs[offset + 2] = x + w;
        uvs[offset + 3] = y - h;

        // Top Right (TR)
        uvs[offset + 4] = x + w;
        uvs[offset + 5] = y;

        // Top Left (TL)
        uvs[offset + 6] = x;
        uvs[offset + 7] = y;
      }
      geometry.attributes.uv.needsUpdate = true;
    }

    function setHeadUVs(geometry) {
      setUVs(
        geometry,
        8, 8, 8, 8, // Front (8, 8, 8, 8)
        24, 8, 8, 8, // Back (24, 8, 8, 8)
        8, 0, 8, 8, // Top (8, 0, 8, 8)
        16, 0, 8, 8, // Bottom (16, 0, 8, 8)
        0, 8, 8, 8, // Left (0, 8, 8, 8)
        16, 8, 8, 8 // Right (16, 8, 8, 8)
      );
    }

    function createMinecraftModel() {
      if (skinMesh) {
        scene.remove(skinMesh);
      }

      const group = new THREE.Group();
      const texture = new THREE.Texture(skinCanvas);
      texture.needsUpdate = true;
      const material = new THREE.MeshLambertMaterial({
        map: texture,
        transparent: true,
        alphaTest: 0.5
      });

      // Head
      const headGeo = new THREE.BoxGeometry(8, 8, 8);
      const head = new THREE.Mesh(headGeo, material);
      head.position.y = 10;
      setHeadUVs(headGeo);
      group.add(head);

      // Torso
      const torsoGeo = new THREE.BoxGeometry(8, 12, 4);
      const torso = new THREE.Mesh(torsoGeo, material);
      torso.position.y = 4;
      setUVs(torsoGeo, 20, 20, 8, 12, 32, 20, 8, 12, 20, 16, 8, 4, 28, 16, 8, 4, 16, 20, 4, 12, 28, 20, 4, 12);
      group.add(torso);

      // Arms
      const armWidth = avatarState.modelType === 'slim' ? 3 : 4;
      const armOffset = avatarState.modelType === 'slim' ? 5.5 : 6;

      // Right Arm
      const rightArmGeo = new THREE.BoxGeometry(armWidth, 12, 4);
      const rightArm = new THREE.Mesh(rightArmGeo, material);
      rightArm.position.set(-armOffset, 4, 0);
      setUVs(rightArmGeo, 44, 20, 4, 12, 52, 20, 4, 12, 44, 16, 4, 4, 48, 16, 4, 4, 40, 20, 4, 12, 48, 20, 4, 12);
      group.add(rightArm);

      // Left Arm
      const leftArmGeo = new THREE.BoxGeometry(armWidth, 12, 4);
      const leftArm = new THREE.Mesh(leftArmGeo, material);
      leftArm.position.set(armOffset, 4, 0);
      setUVs(leftArmGeo, 36, 52, 4, 12, 44, 52, 4, 12, 36, 48, 4, 4, 40, 48, 4, 4, 32, 52, 4, 12, 40, 52, 4, 12);
      group.add(leftArm);


      // Legs
      const legWidth = 4;
      const legOffset = 2;

      // Right Leg
      const rightLegGeo = new THREE.BoxGeometry(legWidth, 12, 4);
      const rightLeg = new THREE.Mesh(rightLegGeo, material);
      rightLeg.position.set(-legOffset, -2, 0);
      setUVs(rightLegGeo, 4, 20, 4, 12, 12, 20, 4, 12, 4, 16, 4, 4, 8, 16, 4, 4, 0, 20, 4, 12, 8, 20, 4, 12);
      group.add(rightLeg);

      // Left Leg
      const leftLegGeo = new THREE.BoxGeometry(legWidth, 12, 4);
      const leftLeg = new THREE.Mesh(leftLegGeo, material);
      leftLeg.position.set(legOffset, -2, 0);
      setUVs(leftLegGeo, 20, 52, 4, 12, 28, 52, 4, 12, 20, 48, 4, 4, 24, 48, 4, 4, 16, 52, 4, 12, 24, 52, 4, 12);
      group.add(leftLeg);

      skinMesh = group;
      scene.add(skinMesh);
    }

    function setup3DViewer(container, initialCameraZ = 35) {
      // Scene
      scene = new THREE.Scene();

      // Camera
      camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 1, 1000);
      camera.position.z = initialCameraZ;
      camera.position.y = 4;

      // Renderer
      renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true
      });
      renderer.setClearColor(0x000000, 0); // Transparent background
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      container.appendChild(renderer.domElement);

      // Lighting
      const light = new THREE.DirectionalLight(0xffffff, 0.8);
      light.position.set(2, 5, 4);
      scene.add(light);
      scene.add(new THREE.AmbientLight(0x404040, 1.5));

      // Animation Loop
      function animate() {
        requestAnimationFrame(animate);

        if (skinMesh) {
          skinMesh.rotation.y += 0.005; // Gentle rotation
        }
        renderer.render(scene, camera);
      }

      // Handle resize
      window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
      });

      // User Interaction (Rotate/Zoom)
      let isDragging = false;
      let previousMousePosition = {
        x: 0,
        y: 0
      };
      renderer.domElement.addEventListener('mousedown', (e) => {
        isDragging = true;
        previousMousePosition = {
          x: e.clientX,
          y: e.clientY
        };
      });
      renderer.domElement.addEventListener('mousemove', (e) => {
        if (isDragging && skinMesh) {
          const deltaX = e.clientX - previousMousePosition.x;
          skinMesh.rotation.y += deltaX * 0.01;
          previousMousePosition = {
            x: e.clientX,
            y: e.clientY
          };
        }
      });
      renderer.domElement.addEventListener('mouseup', () => {
        isDragging = false;
      });
      renderer.domElement.addEventListener('wheel', (e) => {
        e.preventDefault();
        camera.position.z += e.deltaY * 0.05;
        camera.position.z = Math.max(25, Math.min(50, camera.position.z));
      });

      animate();
    }

    // --- UI/State Management ---

    function updatePreview(updateHistory = true) {
      generateSkin(updateHistory);
      if (skinTexture) {
        skinTexture.needsUpdate = true;
        if (skinMesh) {
          // If the model exists, force a rotation update to refresh
          skinMesh.rotation.y += 0.0001;
        } else {
          // If model doesn't exist, create it.
          createMinecraftModel();
        }
      } else {
        createMinecraftModel();
      }
      updateHistoryButtons();
    }

    function updateUIFromState() {
      // Update toggle buttons
      if (document.getElementById('blush-toggle')) {
        document.getElementById('blush-toggle').classList.toggle('active', avatarState.hasBlush);
        document.getElementById('blush-toggle').setAttribute('aria-checked', avatarState.hasBlush ? 'true' : 'false');
      }
      if (document.getElementById('glasses-toggle')) {
        document.getElementById('glasses-toggle').classList.toggle('active', avatarState.hasGlasses);
        document.getElementById('glasses-toggle').setAttribute('aria-checked', avatarState.hasGlasses ? 'true' : 'false');
      }

      // Update option buttons
      document.querySelectorAll('.option-btn').forEach(btn => {
        btn.classList.remove('selected');
        const key = Object.keys(avatarState).find(k => k.toLowerCase().includes(btn.dataset.model || btn.dataset.facestyle || btn.dataset.hairstyle || btn.dataset.bangs || btn.dataset.hairtexture || btn.dataset.expression || btn.dataset.top || btn.dataset.bottom || btn.dataset.footwear || btn.dataset.pattern));
        if (key && avatarState[key] === btn.dataset[Object.keys(btn.dataset)[0]]) {
          btn.classList.add('selected');
        } else if (btn.dataset.pattern === 'none' && !avatarState.pattern) {
          btn.classList.add('selected');
        }
      });

      updateExpressionButtons();
    }

    function updateExpressionButtons() {
      document.querySelectorAll('[data-expression]').forEach(btn => {
        btn.classList.remove('selected');
        if (avatarState.expression === btn.dataset.expression) {
          btn.classList.add('selected');
        }
      });
    }


    function populateColorGrids() {
      const grids = [{
        id: 'skin-tone-grid',
        colors: skinTones,
        key: 'skinTone'
      }, {
        id: 'hair-color-grid',
        colors: hairColors,
        key: 'hairColor'
      }, {
        id: 'eye-color-grid',
        colors: hairColors, // Using hair colors for variety
        key: 'eyeColor'
      }, {
        id: 'glasses-color-grid',
        colors: glassesColors,
        key: 'glassesColor'
      }, {
        id: 'top-color-grid',
        colors: topColors,
        key: 'topColor'
      }, {
        id: 'bottom-color-grid',
        colors: bottomColors,
        key: 'bottomColor'
      }, {
        id: 'footwear-color-grid',
        colors: footwearColors,
        key: 'footwearColor'
      }, {
        id: 'pattern-color1-grid',
        colors: topColors,
        key: 'patternColor1'
      }, {
        id: 'pattern-color2-grid',
        colors: bottomColors,
        key: 'patternColor2'
      }, ];

      grids.forEach(gridInfo => {
        const grid = document.getElementById(gridInfo.id);
        if (!grid) return;
        grid.innerHTML = '';
        gridInfo.colors.forEach(color => {
          const button = document.createElement('button');
          button.className = 'color-swatch';
          button.style.backgroundColor = color;
          button.setAttribute('data-color', color);
          button.setAttribute('aria-label', `Select color ${color}`);

          if (avatarState[gridInfo.key] === color) {
            button.classList.add('selected');
          }

          button.addEventListener('click', function() {
            // Deselect all swatches in this grid
            grid.querySelectorAll('.color-swatch').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            avatarState[gridInfo.key] = color;
            speak(translations[currentLanguage][gridInfo.key] + ' set');
            updatePreview();
          });
          grid.appendChild(button);
        });
      });
    }

    // --- Editor Functions ---

    function saveCurrentFace(pushHistory = true) {
      if (!FACE_MAP[currentBodyPart]) return;
      const face = FACE_MAP[currentBodyPart][currentFace];
      const data = skinContext.getImageData(face.x, face.y, face.w, face.h);

      if (!bodyPartFaces[currentBodyPart]) {
        bodyPartFaces[currentBodyPart] = {};
      }
      bodyPartFaces[currentBodyPart][currentFace] = data;

      if (pushHistory) {
        pushToEditorHistory(currentBodyPart, currentFace, data);
      }
    }

    function loadFaceToEditor(bodyPart = currentBodyPart, face = currentFace) {
      if (!FACE_MAP[bodyPart]) return;
      const faceInfo = FACE_MAP[bodyPart][face];
      currentBodyPart = bodyPart;
      currentFace = face;

      editorCanvas.width = faceInfo.w;
      editorCanvas.height = faceInfo.h;

      // Calculate display size (Fixed pixel size of 50px)
      const PIXEL_SIZE = 50;
      const displayWidth = faceInfo.w * PIXEL_SIZE;
      const displayHeight = faceInfo.h * PIXEL_SIZE;
      editorCanvas.style.width = displayWidth + 'px';
      editorCanvas.style.height = displayHeight + 'px';

      // Draw the image data to the editor canvas
      if (bodyPartFaces[bodyPart] && bodyPartFaces[bodyPart][face]) {
        editorContext.putImageData(bodyPartFaces[bodyPart][face], 0, 0);
      } else {
        // If no data saved, load from skin context (fresh load)
        const data = skinContext.getImageData(faceInfo.x, faceInfo.y, faceInfo.w, faceInfo.h);
        editorContext.putImageData(data, 0, 0);
        bodyPartFaces[bodyPart] = bodyPartFaces[bodyPart] || {};
        bodyPartFaces[bodyPart][face] = data;
        pushToEditorHistory(bodyPart, face, data); // Initial state
      }

      // Update the hidden canvas with the current editor view
      updateSkinCanvasFromEditor();
    }

    function pushToEditorHistory(bodyPart, face, imageData) {
      const historyItem = {
        bodyPart,
        face,
        imageData: editorContext.createImageData(imageData.width, imageData.height),
      };
      historyItem.imageData.data.set(imageData.data);

      editorHistoryStack.splice(editorHistoryIndex + 1); // Clear redo history
      editorHistoryStack.push(historyItem);
      editorHistoryIndex = editorHistoryStack.length - 1;

      if (editorHistoryStack.length > 50) {
        editorHistoryStack.shift();
        editorHistoryIndex--;
      }
      updateEditorHistoryButtons();
    }

    function updateEditorHistoryButtons() {
      const undoBtn = document.getElementById('editor-undo-btn');
      const redoBtn = document.getElementById('editor-redo-btn');
      if (undoBtn) {
        undoBtn.disabled = editorHistoryIndex <= 0;
      }
      if (redoBtn) {
        redoBtn.disabled = editorHistoryIndex >= editorHistoryStack.length - 1;
      }
    }

    function undoEditor() {
      if (editorHistoryIndex > 0) {
        editorHistoryIndex--;
        applyEditorHistory();
      }
    }

    function redoEditor() {
      if (editorHistoryIndex < editorHistoryStack.length - 1) {
        editorHistoryIndex++;
        applyEditorHistory();
      }
    }

    function applyEditorHistory() {
      const historyItem = editorHistoryStack[editorHistoryIndex];
      const faceInfo = FACE_MAP[historyItem.bodyPart][historyItem.face];

      // If body part or face changed, switch the editor view
      if (historyItem.bodyPart !== currentBodyPart || historyItem.face !== currentFace) {
        currentBodyPart = historyItem.bodyPart;
        currentFace = historyItem.face;
        document.getElementById('body-part-select').value = currentBodyPart;
        document.getElementById('face-select').value = currentFace;
        // Reload editor with new size/content
        loadFaceToEditor(currentBodyPart, currentFace);
        return;
      }

      // Apply image data to the editor canvas
      editorCanvas.width = historyItem.imageData.width;
      editorCanvas.height = historyItem.imageData.height;
      editorContext.putImageData(historyItem.imageData, 0, 0);

      // Save the state to the skin canvas (preview) and bodyPartFaces
      updateSkinCanvasFromEditor(false); // Don't push to history, already in history stack
      bodyPartFaces[currentBodyPart][currentFace] = historyItem.imageData;

      updateEditorHistoryButtons();
    }

    function updateSkinCanvasFromEditor(pushHistory = true) {
      const face = FACE_MAP[currentBodyPart][currentFace];
      const data = editorContext.getImageData(0, 0, face.w, face.h);

      skinContext.putImageData(data, face.x, face.y);
      if (skinTexture) skinTexture.needsUpdate = true;
      if (pushHistory) {
        saveCurrentFace(true);
      }
    }

    function handleEditorInput(e) {
      e.preventDefault();
      const rect = editorCanvas.getBoundingClientRect();
      const scaleX = editorCanvas.width / rect.width;
      const scaleY = editorCanvas.height / rect.height;

      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);

      const x = (clientX - rect.left) * scaleX;
      const y = (clientY - rect.top) * scaleY;

      const px = Math.floor(x);
      const py = Math.floor(y);

      if (px >= 0 && px < editorCanvas.width && py >= 0 && py < editorCanvas.height) {
        const faceInfo = FACE_MAP[currentBodyPart][currentFace];
        const data = editorContext.getImageData(0, 0, faceInfo.w, faceInfo.h);

        // Save current state before drawing for undo/redo
        saveCurrentFace(true);

        const color = document.getElementById('brush-color').value;
        const colorRgb = hexToRgb(color);
        const dataIndex = (py * faceInfo.w + px) * 4;

        if (currentTool === 'pen') {
          data.data[dataIndex] = colorRgb.r;
          data.data[dataIndex + 1] = colorRgb.g;
          data.data[dataIndex + 2] = colorRgb.b;
          data.data[dataIndex + 3] = 255; // Full opacity
        } else if (currentTool === 'eraser') {
          data.data[dataIndex + 3] = 0; // Full transparency
        }

        editorContext.putImageData(data, 0, 0);
        updateSkinCanvasFromEditor(false);
      }
    }

    // --- Language/Accessibility ---

    const translations = {
      en: {
        title: "ğŸ® MINECRAFT ME! ğŸ®",
        instructions: "Create your unique Minecraft character!",
        downloadText: "Download for Minecraft",
        openText: "Open My Design",
        saveText: "Save My Draft",
        randomize: "ğŸ² Randomize Avatar",
        undo: "â†©ï¸ Undo",
        redo: "â†ªï¸ Redo",
        tabIdentity: "IDENTITY",
        tabClothing: "CLOTHING",
        tabDecals: "DECALS",
        tabEditor: "EDITOR",
        modelType: "ğŸ§ Model Type",
        standard: "ğŸ§ Standard",
        slim: "ğŸ§˜ Slim",
        faceStyle: "ğŸ˜Š Face Style",
        classic: "ğŸ® Classic",
        anime: "âœ¨ Anime",
        skinTone: "ğŸ¨ Skin Tone",
        hairColor: "ğŸ’‡ Hair Color",
        hairStyle: "ğŸ’‡â€â™€ï¸ Hair Style",
        short: "âœ‚ï¸ Short",
        long: "ğŸ‘© Long",
        bald: "ğŸ§‘â€ğŸ¦² Bald",
        bangs: "âœ¨ Bangs",
        bangsShort: "Short",
        bangsLong: "Long",
        bangsLayered: "Layered",
        bangsAsymmetric: "Asymmetric",
        hairTexture: "ğŸŒ€ Hair Texture",
        straight: "ğŸ“ Straight",
        wavy: "ã€°ï¸ Wavy",
        curly: "ğŸŒ€ Curly",
        eyeColor: "ğŸ‘ï¸ Eye Color",
        facialFeatures: "ğŸ˜Š Facial Features",
        blush: "Blush",
        expression: "ğŸ˜„ Expression",
        smile: "ğŸ™‚ Smile",
        happy: "ğŸ˜„ Happy",
        neutral: "ğŸ˜ Neutral",
        surprised: "ğŸ˜® Surprised",
        glasses: "ğŸ‘“ Glasses",
        wearGlasses: "Wear Glasses",
        glassesColor: "Glasses Color",
        tops: "ğŸ‘• Tops",
        tshirt: "ğŸ‘• T-Shirt",
        hoodie: "ğŸ§¥ Hoodie",
        tank: "ğŸ½ Tank Top",
        polo: "ğŸ‘” Polo",
        topColor: "Top Color",
        bottoms: "ğŸ‘– Bottoms",
        jeans: "ğŸ‘– Jeans",
        shorts: "ğŸ©³ Shorts",
        cargo: "ğŸ’ Cargo Pants",
        joggers: "ğŸƒ Joggers",
        bottomColor: "Bottom Color",
        footwear: "ğŸ‘Ÿ Footwear",
        sneakers: "ğŸ‘Ÿ Sneakers",
        boots: "ğŸ¥¾ Boots",
        converse: "ğŸ‘Ÿ High Tops",
        dress: "ğŸ‘ Dress Shoes",
        footwearColor: "Footwear Color",
        patternTemplates: "ğŸ“ Pattern Templates",
        checkers: "ğŸ Checkers",
        hstripes: "â– H-Stripes",
        vstripes: "ã€°ï¸ V-Stripes",
        dots: "âš« Dots",
        plaid: "ğŸ”² Plaid",
        camo: "ğŸŒ¿ Camo",
        patternColor1: "Pattern Color 1",
        patternColor2: "Pattern Color 2",
        stickerLibrary: "âœ¨ Sticker Library",
        advancedPixelEditor: "ğŸ¨ Advanced Pixel Editor",
        openEditor: "ğŸ¨ Open Advanced Editor",
        editorDescription: "Click the button below to open the full-screen advanced editor with live preview!"
      },
      es: {
        title: "ğŸ® Â¡MINECRAFT YO! ğŸ®",
        instructions: "Â¡Crea tu personaje Ãºnico de Minecraft!",
        downloadText: "Descargar para Minecraft",
        openText: "Abrir Mi DiseÃ±o",
        saveText: "Guardar Mi Borrador",
        randomize: "ğŸ² Avatar Aleatorio",
        undo: "â†©ï¸ Deshacer",
        redo: "â†ªï¸ Rehacer",
        tabIdentity: "IDENTIDAD",
        tabClothing: "ROPA",
        tabDecals: "CALCOMANÃAS",
        tabEditor: "EDITOR",
        modelType: "ğŸ§ Tipo de Cuerpo",
        standard: "ğŸ§ EstÃ¡ndar",
        slim: "ğŸ§˜ Delgado",
        faceStyle: "ğŸ˜Š Estilo de Cara",
        classic: "ğŸ® ClÃ¡sico",
        anime: "âœ¨ Anime",
        skinTone: "ğŸ¨ Tono de Piel",
        hairColor: "ğŸ’‡ Color de Pelo",
        hairStyle: "ğŸ’‡â€â™€ï¸ Estilo de Pelo",
        short: "âœ‚ï¸ Corto",
        long: "ğŸ‘© Largo",
        bald: "ğŸ§‘â€ğŸ¦² Calvo",
        bangs: "âœ¨ Flequillo",
        bangsShort: "Corto",
        bangsLong: "Largo",
        bangsLayered: "En Capas",
        bangsAsymmetric: "AsimÃ©trico",
        hairTexture: "ğŸŒ€ Textura de Pelo",
        straight: "ğŸ“ Liso",
        wavy: "ã€°ï¸ Ondulado",
        curly: "ğŸŒ€ Rizado",
        eyeColor: "ğŸ‘ï¸ Color de Ojos",
        facialFeatures: "ğŸ˜Š CaracterÃ­sticas Faciales",
        blush: "Rubor",
        expression: "ğŸ˜„ ExpresiÃ³n",
        smile: "ğŸ™‚ Sonrisa",
        happy: "ğŸ˜„ Feliz",
        neutral: "ğŸ˜ Neutral",
        surprised: "ğŸ˜® Sorprendido",
        glasses: "ğŸ‘“ Gafas",
        wearGlasses: "Usar Gafas",
        glassesColor: "Color de Gafas",
        tops: "ğŸ‘• Parte Superior",
        tshirt: "ğŸ‘• Camiseta",
        hoodie: "ğŸ§¥ Sudadera",
        tank: "ğŸ½ Camiseta sin Mangas",
        polo: "ğŸ‘” Polo",
        topColor: "Color Superior",
        bottoms: "ğŸ‘– Parte Inferior",
        jeans: "ğŸ‘– Jeans",
        shorts: "ğŸ©³ Pantalones Cortos",
        cargo: "ğŸ’ Pantalones Cargo",
        joggers: "ğŸƒ Joggers",
        bottomColor: "Color Inferior",
        footwear: "ğŸ‘Ÿ Calzado",
        sneakers: "ğŸ‘Ÿ Zapatillas",
        boots: "ğŸ¥¾ Botas",
        converse: "ğŸ‘Ÿ High Tops",
        dress: "ğŸ‘ Zapatos de Vestir",
        footwearColor: "Color de Calzado",
        patternTemplates: "ğŸ“ Plantillas de Patrones",
        checkers: "ğŸ Cuadros",
        hstripes: "â– Rayas H",
        vstripes: "ã€°ï¸ Rayas V",
        dots: "âš« Puntos",
        plaid: "ğŸ”² Cuadros Escoceses",
        camo: "ğŸŒ¿ Camuflaje",
        patternColor1: "Color de PatrÃ³n 1",
        patternColor2: "Color de PatrÃ³n 2",
        stickerLibrary: "âœ¨ Biblioteca de CalcomanÃ­as",
        advancedPixelEditor: "ğŸ¨ Editor de PÃ­xeles Avanzado",
        openEditor: "ğŸ¨ Abrir Editor Avanzado",
        editorDescription: "Â¡Haz clic en el botÃ³n de abajo para abrir el editor avanzado de pantalla completa con vista previa en vivo!"
      }
    };

    function speak(text) {
      if (!ttsEnabled || !window.speechSynthesis) return;
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = currentLanguage === 'es' ? 'es-ES' : 'en-US';
      utterance.rate = 0.9;
      window.speechSynthesis.speak(utterance);
    }

    function updateLanguage() {
      const t = translations[currentLanguage];
      document.getElementById('app-title').textContent = t.title;
      document.getElementById('instructions').textContent = t.instructions;
      document.getElementById('download-text').textContent = t.downloadText;
      document.getElementById('open-text').textContent = t.openText;
      document.getElementById('save-text').textContent = t.saveText;
      document.getElementById('randomize-btn').innerHTML = t.randomize;

      // Update Tab Buttons
      document.querySelector('[data-tab="identity"]').textContent = t.tabIdentity;
      document.querySelector('[data-tab="clothing"]').textContent = t.tabClothing;
      document.querySelector('[data-tab="decals"]').textContent = t.tabDecals;
      document.querySelector('[data-tab="editor"]').textContent = t.tabEditor;

      // Update Identity Tab
      const identitySections = document.querySelectorAll('#identity-tab .section-title');
      identitySections[0].innerHTML = t.modelType;
      document.querySelector('[data-model="standard"]').innerHTML = t.standard;
      document.querySelector('[data-model="slim"]').innerHTML = t.slim;
      identitySections[1].innerHTML = t.faceStyle;
      document.querySelector('[data-facestyle="classic"]').innerHTML = t.classic;
      document.querySelector('[data-facestyle="anime"]').innerHTML = t.anime;
      identitySections[2].innerHTML = t.skinTone;
      identitySections[3].innerHTML = t.hairColor;
      identitySections[4].innerHTML = t.hairStyle;
      document.querySelector('[data-hairstyle="short"]').innerHTML = t.short;
      document.querySelector('[data-hairstyle="long"]').innerHTML = t.long;
      document.querySelector('[data-hairstyle="none"]').innerHTML = t.bald;
      identitySections[5].innerHTML = t.bangs;
      document.querySelector('[data-bangs="short"]').textContent = t.bangsShort;
      document.querySelector('[data-bangs="long"]').textContent = t.bangsLong;
      document.querySelector('[data-bangs="layered"]').textContent = t.bangsLayered;
      document.querySelector('[data-bangs="asymmetric"]').textContent = t.bangsAsymmetric;
      identitySections[6].innerHTML = t.hairTexture;
      document.querySelector('[data-hairtexture="straight"]').innerHTML = t.straight;
      document.querySelector('[data-hairtexture="wavy"]').innerHTML = t.wavy;
      document.querySelector('[data-hairtexture="curly"]').innerHTML = t.curly;
      identitySections[7].innerHTML = t.eyeColor;
      identitySections[8].innerHTML = t.facialFeatures;
      document.querySelectorAll('.switch-label')[0].textContent = t.blush;
      identitySections[9].innerHTML = t.expression;
      document.querySelector('[data-expression="smile"]').innerHTML = t.smile;
      document.querySelector('[data-expression="happy"]').innerHTML = t.happy;
      document.querySelector('[data-expression="neutral"]').innerHTML = t.neutral;
      document.querySelector('[data-expression="surprised"]').innerHTML = t.surprised;
      identitySections[10].innerHTML = t.glasses;
      document.querySelectorAll('.switch-label')[1].textContent = t.wearGlasses;
      document.getElementById('glasses-color-label').textContent = t.glassesColor;

      // Update Clothing Tab
      const clothingSections = document.querySelectorAll('#clothing-tab .section-title');
      clothingSections[0].innerHTML = t.tops;
      document.querySelector('[data-top="tshirt"]').innerHTML = t.tshirt;
      document.querySelector('[data-top="hoodie"]').innerHTML = t.hoodie;
      document.querySelector('[data-top="tank"]').innerHTML = t.tank;
      document.querySelector('[data-top="polo"]').innerHTML = t.polo;
      document.querySelectorAll('#clothing-tab label')[0].textContent = t.topColor;
      clothingSections[1].innerHTML = t.bottoms;
      document.querySelector('[data-bottom="jeans"]').innerHTML = t.jeans;
      document.querySelector('[data-bottom="shorts"]').innerHTML = t.shorts;
      document.querySelector('[data-bottom="cargo"]').innerHTML = t.cargo;
      document.querySelector('[data-bottom="joggers"]').innerHTML = t.joggers;
      document.querySelectorAll('#clothing-tab label')[1].textContent = t.bottomColor;
      clothingSections[2].innerHTML = t.footwear;
      document.querySelector('[data-footwear="sneakers"]').innerHTML = t.sneakers;
      document.querySelector('[data-footwear="boots"]').innerHTML = t.boots;
      document.querySelector('[data-footwear="converse"]').innerHTML = t.converse;
      document.querySelector('[data-footwear="dress"]').innerHTML = t.dress;
      document.querySelectorAll('#clothing-tab label')[2].textContent = t.footwearColor;
      clothingSections[3].innerHTML = t.patternTemplates;
      document.querySelector('[data-pattern="checkers"]').innerHTML = t.checkers;
      document.querySelector('[data-pattern="hstripes"]').innerHTML = t.hstripes;
      document.querySelector('[data-pattern="vstripes"]').innerHTML = t.vstripes;
      document.querySelector('[data-pattern="dots"]').innerHTML = t.dots;
      document.querySelector('[data-pattern="plaid"]').innerHTML = t.plaid;
      document.querySelector('[data-pattern="camo"]').innerHTML = t.camo;
      document.querySelectorAll('#clothing-tab label')[3].textContent = t.patternColor1;
      document.querySelectorAll('#clothing-tab label')[4].textContent = t.patternColor2;

      // Update Decals Tab
      document.querySelector('#decals-tab .section-title').innerHTML = t.stickerLibrary;

      // Update Editor Tab
      document.querySelector('#editor-tab .section-title').innerHTML = t.advancedPixelEditor;
      document.querySelector('#editor-tab p').textContent = t.editorDescription;
      document.getElementById('open-editor-text').textContent = t.openEditor;
    }


    // --- Event Listeners ---

    window.onload = function() {
      // Initialize 3D Viewer
      const previewContainer = document.getElementById('preview-canvas');
      setup3DViewer(previewContainer);

      // Initial drawing and state save
      generateSkin(false); // Draw initial skin without saving to history
      saveToHistory(); // Save the initial state

      // Populate color grids and update UI
      populateColorGrids();
      updateUIFromState();
      updateHistoryButtons();
      updateLanguage();

      // Language Toggle
      document.getElementById('language-toggle').addEventListener('click', function() {
        currentLanguage = currentLanguage === 'en' ? 'es' : 'en';
        this.textContent = currentLanguage === 'en' ? 'ğŸŒ EspaÃ±ol' : 'ğŸŒ English';
        updateLanguage();
        speak(translations[currentLanguage].title);
      });

      // TTS Toggle
      document.getElementById('tts-toggle').addEventListener('click', function() {
        ttsEnabled = !ttsEnabled;
        this.classList.toggle('active', ttsEnabled);
        this.textContent = ttsEnabled ? 'ğŸ”Š Text-to-Speech' : 'ğŸ”‡ Text-to-Speech';
        speak(ttsEnabled ? 'Text-to-speech enabled' : 'Text-to-speech disabled');
      });

      // Fullscreen Toggle
      document.getElementById('fullscreen-toggle').addEventListener('click', function() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      });

      // Tab Navigation
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          document.getElementById(this.dataset.tab + '-tab').classList.add('active');
          speak(this.textContent);
        });
      });

      // Identity Options
      document.querySelectorAll('[data-model]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-model]').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          avatarState.modelType = this.dataset.model;
          speak(this.textContent);
          updatePreview();
        });
      });
      document.querySelectorAll('[data-facestyle]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-facestyle]').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          avatarState.faceStyle = this.dataset.facestyle;
          speak(this.textContent);
          updatePreview();
        });
      });
      document.querySelectorAll('[data-hairstyle]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-hairstyle]').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          avatarState.hairStyle = this.dataset.hairstyle;
          speak(this.textContent);
          updatePreview();
        });
      });
      document.querySelectorAll('[data-hairtexture]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-hairtexture]').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          avatarState.hairTexture = this.dataset.hairtexture;
          speak(this.textContent);
          updatePreview();
        });
      });
      document.querySelectorAll('[data-bangs]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-bangs]').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          avatarState.bangsStyle = this.dataset.bangs;
          speak(this.textContent);
          updatePreview();
        });
      });
      document.getElementById('blush-toggle').addEventListener('click', function() {
        avatarState.hasBlush = !avatarState.hasBlush;
        this.classList.toggle('active');
        this.setAttribute('aria-checked', avatarState.hasBlush ? 'true' : 'false');
        const t = translations[currentLanguage];
        speak(t.blush + (avatarState.hasBlush ? ' on' : ' off'));
        updatePreview();
        saveToHistory();
      });
      document.querySelectorAll('[data-expression]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-expression]').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          avatarState.expression = this.dataset.expression;
          speak(this.textContent);
          updatePreview();
          saveToHistory();
        });
      });
      document.getElementById('glasses-toggle').addEventListener('click', function() {
        avatarState.hasGlasses = !avatarState.hasGlasses;
        this.classList.toggle('active');
        this.setAttribute('aria-checked', avatarState.hasGlasses ? 'true' : 'false');
        const t = translations[currentLanguage];
        speak(t.glasses + (avatarState.hasGlasses ? ' on' : ' off'));
        updatePreview();
        saveToHistory();
      });

      // Clothing Options
      document.querySelectorAll('[data-top]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-top]').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          avatarState.topStyle = this.dataset.top;
          speak(this.textContent);
          updatePreview();
          saveToHistory();
        });
      });
      document.querySelectorAll('[data-bottom]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-bottom]').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          avatarState.bottomStyle = this.dataset.bottom;
          speak(this.textContent);
          updatePreview();
          saveToHistory();
        });
      });
      document.querySelectorAll('[data-footwear]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-footwear]').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          avatarState.footwear = this.dataset.footwear;
          speak(this.textContent);
          updatePreview();
          saveToHistory();
        });
      });
      document.querySelectorAll('[data-pattern]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-pattern]').forEach(b => b.classList.remove('selected'));
          const patternType = this.dataset.pattern;
          if (patternType === 'none') {
            avatarState.pattern = null;
            this.classList.add('selected');
            speak('Pattern removed');
          } else if (avatarState.pattern === patternType) {
            avatarState.pattern = null;
            this.classList.add('selected');
            speak('Pattern removed');
          } else {
            this.classList.add('selected');
            avatarState.pattern = patternType;
            speak(this.textContent);
          }
          updatePreview();
          saveToHistory();
        });
      });

      // Decals Options
      document.querySelectorAll('.sticker-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const stickerType = this.dataset.sticker;
          document.querySelectorAll('.sticker-btn').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');

          if (stickerType === 'none') {
            avatarState.currentSticker = null;
            speak('Sticker removed');
          } else {
            avatarState.currentSticker = {
              emoji: this.textContent
            };
            speak('Sticker added');
          }
          updatePreview();
          saveToHistory();
        });
      });

      // Randomize Button
      document.getElementById('randomize-btn').addEventListener('click', function() {
        const randomElement = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const getRandomOption = (selector) => {
          const options = Array.from(document.querySelectorAll(selector));
          return randomElement(options).dataset[Object.keys(options[0].dataset)[0]];
        };

        avatarState.modelType = getRandomOption('[data-model]');
        avatarState.faceStyle = getRandomOption('[data-facestyle]');
        avatarState.skinTone = randomElement(skinTones);
        avatarState.hairColor = randomElement(hairColors);
        avatarState.hairStyle = getRandomOption('[data-hairstyle]');
        avatarState.bangsStyle = getRandomOption('[data-bangs]');
        avatarState.hairTexture = getRandomOption('[data-hairtexture]');
        avatarState.eyeColor = randomElement(hairColors);
        avatarState.hasBlush = Math.random() < 0.5;
        avatarState.expression = getRandomOption('[data-expression]');
        avatarState.hasGlasses = Math.random() < 0.3;
        avatarState.glassesColor = randomElement(glassesColors);
        avatarState.topStyle = getRandomOption('[data-top]');
        avatarState.topColor = randomElement(topColors);
        avatarState.bottomStyle = getRandomOption('[data-bottom]');
        avatarState.bottomColor = randomElement(bottomColors);
        avatarState.footwear = getRandomOption('[data-footwear]');
        avatarState.footwearColor = randomElement(footwearColors);
        avatarState.pattern = Math.random() < 0.7 ? null : getRandomOption('[data-pattern]:not([data-pattern="none"])');
        avatarState.patternColor1 = randomElement(topColors);
        avatarState.patternColor2 = randomElement(bottomColors);

        // Update UI elements from new state
        populateColorGrids();
        updateUIFromState();
        if (avatarState.hasBlush) {
          document.getElementById('blush-toggle').classList.add('active');
        } else {
          document.getElementById('blush-toggle').classList.remove('active');
        }
        if (avatarState.hasGlasses) {
          document.getElementById('glasses-toggle').classList.add('active');
        } else {
          document.getElementById('glasses-toggle').classList.remove('active');
        }

        speak('Avatar randomized');
        updateExpressionButtons();
        updatePreview();
        saveToHistory();
      });

      // Download Button (FIXED)
      document.getElementById('download-btn').addEventListener('click', async function() {
        try {
          if (!window.JSZip) {
            // This fallback should not be needed if script is loaded, but safe to keep
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
            document.head.appendChild(script);
            await new Promise(resolve => script.onload = resolve);
          }
          const zip = new JSZip();
          const skinName = getSkinName();
          if (!skinName) return; // Don't download if name is invalid
          const skinDataUrl = skinCanvas.toDataURL('image/png');
          const skinBase64 = skinDataUrl.split(',')[1];

          // Minecraft Skin Pack Manifest (JSON structure)
          const manifest = {
            "format_version": 2,
            "header": {
              "name": skinName,
              "description": "My custom Minecraft skin created with Minecraft Me!",
              "uuid": generateUUID(),
              "version": [1, 0, 0],
              "min_engine_version": [1, 13, 0]
            },
            "modules": [{
              "type": "skin_pack",
              "uuid": generateUUID(),
              "version": [1, 0, 0]
            }],
            "skins": [{
              "geometry": avatarState.modelType === 'slim' ? "geometry.slim" : "geometry.humanoid",
              "texture": "skin.png",
              "type": "free",
              "localization_name": skinName.toLowerCase().replace(/[^a-z0-9]/g, '_'),
              "id": `skin_${generateUUID()}`
            }]
          }; // <-- END OF MANIFEST OBJECT

          // Add manifest and skin to zip
          zip.file("manifest.json", JSON.stringify(manifest, null, 2));
          zip.file("skin.png", skinBase64, {
            base64: true
          });

          // Generate and download the zip file as a .mcpack
          const content = await zip.generateAsync({
            type: "blob",
            mimeType: "application/octet-stream",
            compression: "DEFLATE"
          });
          const downloadLink = document.createElement('a');
          downloadLink.href = URL.createObjectURL(content);
          downloadLink.download = `${skinName.replace(/[^a-z0-9]/gi, '_')}.mcpack`;
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);

        } catch (error) {
          console.error("Download failed:", error);
          alert("Sorry, the download failed. Check the console for details.");
        }
      }); // <-- END OF EVENT LISTENER

      // --- Editor Event Listeners ---

      const editorOverlay = document.getElementById('editor-overlay');
      const editorPreview3D = document.getElementById('editor-preview-3d');

      document.getElementById('open-editor-btn').addEventListener('click', function() {
        editorOverlay.classList.add('active');
        // Setup 3D viewer for the editor if not already done
        if (!scene || editorPreview3D.children.length === 0) {
          setup3DViewer(editorPreview3D, 20); // Closer view for editing
        }
        // Save the current drawing to the hidden canvas data
        for (const part in FACE_MAP) {
          for (const face in FACE_MAP[part]) {
            const faceInfo = FACE_MAP[part][face];
            const data = skinContext.getImageData(faceInfo.x, faceInfo.y, faceInfo.w, faceInfo.h);
            if (!bodyPartFaces[part]) bodyPartFaces[part] = {};
            bodyPartFaces[part][face] = data;
          }
        }
        editorHistoryStack = []; // Clear main history for editor history
        editorHistoryIndex = -1;

        // Load the head/front face initially
        loadFaceToEditor('head', 'front');
        updateEditorHistoryButtons();
      });

      document.getElementById('close-editor-btn').addEventListener('click', function() {
        editorOverlay.classList.remove('active');
      });

      document.getElementById('editor-apply-btn').addEventListener('click', function() {
        // Apply changes back to the main avatar state
        updateSkinCanvasFromEditor(false); // Update skin canvas from editor
        updatePreview(); // Re-render the main 3D model and save to main history
        editorOverlay.classList.remove('active');
        speak('Editor changes applied');
      });

      document.getElementById('body-part-select').addEventListener('change', function() {
        currentBodyPart = this.value;
        currentFace = 'front'; // Reset to front when body part changes
        document.getElementById('face-select').value = 'front';
        loadFaceToEditor(currentBodyPart, currentFace);
      });

      document.getElementById('face-select').addEventListener('change', function() {
        currentFace = this.value;
        loadFaceToEditor(currentBodyPart, currentFace);
      });

      document.getElementById('pen-tool').addEventListener('click', function() {
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentTool = 'pen';
      });
      document.getElementById('eraser-tool').addEventListener('click', function() {
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentTool = 'eraser';
      });
      document.getElementById('dropper-tool').addEventListener('click', function() {
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentTool = 'dropper';
      });
      document.getElementById('fill-tool').addEventListener('click', function() {
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentTool = 'fill';
      });

      editorCanvas.addEventListener('mousedown', handleEditorInput);
      editorCanvas.addEventListener('mousemove', (e) => {
        if (e.buttons === 1) handleEditorInput(e); // Only if left mouse button is held
      });
      editorCanvas.addEventListener('touchstart', handleEditorInput);
      editorCanvas.addEventListener('touchmove', handleEditorInput);

      document.getElementById('editor-undo-btn').addEventListener('click', undoEditor);
      document.getElementById('editor-redo-btn').addEventListener('click', redoEditor);

      // Handle Color Pickers in Editor
      document.getElementById('brush-color').addEventListener('input', function() {
        // Update the global current color for drawing logic if needed
        // For simplicity, we just rely on the input value in handleEditorInput
        // but this could be used to update a 'window.currentColor' if needed.
      });


      // Save/Load Drafts
      document.getElementById('save-draft-btn').addEventListener('click', function() {
        const data = {
          ...avatarState,
          skinDataUrl: skinCanvas.toDataURL(),
          name: getSkinName(),
          config: JSON.parse(JSON.stringify(config))
        };
        const draftJSON = JSON.stringify(data);
        localStorage.setItem('minecraftMeDraft', draftJSON);
        alert('Draft saved successfully to your browser!');
        speak('Draft saved successfully');
      });

      document.getElementById('open-design-btn').addEventListener('click', function() {
        const draftJSON = localStorage.getItem('minecraftMeDraft');
        if (draftJSON) {
          try {
            const loadedState = JSON.parse(draftJSON);
            Object.assign(avatarState, { ...loadedState
            });
            document.getElementById('skin-name').value = loadedState.name;

            const img = new Image();
            img.onload = () => {
              skinContext.clearRect(0, 0, 64, 64);
              skinContext.drawImage(img, 0, 0);
              updatePreview(false);
              updateUIFromState();
              populateColorGrids();
              saveToHistory(); // Save loaded state to history
              alert('Draft loaded successfully!');
              speak('Draft loaded successfully');
            };
            img.src = loadedState.skinDataUrl;

          } catch (e) {
            console.error('Failed to load draft:', e);
            alert('Failed to load draft. The saved data may be corrupted.');
            speak('Failed to load draft');
          }
        } else {
          alert('No saved draft found.');
          speak('No saved draft found');
        }
      });
    };
  </script>

 </body>
</html>
